# Sprint S01 — Infrastructure Foundation

> **狀態**: `completed`
> **預估時間**: 2.5 小時
> **前置 Sprint**: 無

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: 無（首個 Sprint）

### Sprint 目標宣告

> 建立專案骨架，讓 DB 跑起來

### 前置條件檢查

- [x] Docker 已安裝且可執行（Docker 29.2.0）
- [x] Python 環境就緒（Python 3.13.5）
- [x] 已閱讀 `docs/DEVELOPMENT_PLAN.md` Section 1-3

### Session 意圖

- 精神狀態：AI-assisted session
- 時間預算：Full sprint
- 特別注意事項：首個 Sprint，建立所有基礎設施

---

## Stage 1: Sprint Planning

### User Stories

- [ ] **US-1**: 作為開發者，我希望有一份完整的 `requirements.txt`，以便一鍵安裝所有 Python 依賴（streamlit, psycopg2-binary, pydantic, plotly, python-dotenv）
- [ ] **US-2**: 作為開發者，我希望執行 `docker-compose up -d` 就能啟動 PostgreSQL 開發環境，以便不需手動安裝資料庫
- [ ] **US-3**: 作為開發者，我希望有 `.env.example` 作為環境變數範本，以便新成員快速設定本地環境
- [ ] **US-4**: 作為開發者，我希望有完整的 `.gitignore`，以便 `.env`、`__pycache__`、`data/` 等敏感與暫存檔案不會被提交
- [ ] **US-5**: 作為開發者，我希望 `constants.py` 定義所有狀態碼（S01–D03, LOST, HOLD）與動作類型（會議/提案/開發/文件/郵件），以便全專案共用一致的常數
- [ ] **US-6**: 作為開發者，我希望 `database/schema.sql` 包含完整的 8 張表 DDL（PostgreSQL 語法），以便一次建立所有資料表
- [ ] **US-7**: 作為開發者，我希望 `database/connection.py` 實作連線池管理（psycopg2.pool），並提供 `get_connection()` 函式與 `init_db()` 初始化函式，以便其他模組統一取得 DB 連線

### Definition of Done（完成定義）

- [ ] `requirements.txt` 包含 streamlit, psycopg2-binary, pydantic, plotly, python-dotenv
- [ ] `docker-compose.yml` 定義 PostgreSQL 服務，port 5432，含 volume 持久化
- [ ] `.env.example` 包含 DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD 範本
- [ ] `.gitignore` 涵蓋 .env, __pycache__, data/, .DS_Store, *.pyc
- [ ] `constants.py` 導出 STATUS_CODES dict、ACTION_TYPES list、INACTIVE_STATUSES set、VALID_TRANSITIONS dict
- [ ] `database/schema.sql` 包含 8 張表的 CREATE TABLE 語句（annual_plan, crm, project_list, sales_plan, work_log, app_settings, email_log, agent_actions）+ app_settings 初始資料
- [ ] `database/connection.py` 實作 SimpleConnectionPool，提供 get_connection() context manager 與 init_db() 函式
- [ ] `docker-compose up -d` 成功啟動 PostgreSQL
- [ ] `python -c "from database.connection import init_db; init_db()"` 成功建立所有表
- [ ] 所有 `__init__.py` 檔案已建立（database/, models/, services/, pages/, components/）

### Context Files（AI 參考檔案）

開始此 Sprint 前，將以下檔案提供給 AI：
- `docs/DEVELOPMENT_PLAN.md` — Section 1（目錄結構）、Section 2（Schema）、Section 3（狀態機）
- `docs/SPRINT_GUIDE.md` — 了解 Sprint 流程

---

## Stage 2: Vibe Coding

### 實作紀錄

> 在開發過程中記錄重要決策與遇到的問題。

- docker-compose port 從 5432 改為 5433（避免與同機器上的 nexus-postgres 衝突）
- 移除 docker-compose.yml 中已棄用的 `version` 屬性
- connection.py 的 `get_connection()` 採用 context manager，自動 commit/rollback
- constants.py 的 VALID_TRANSITIONS 嚴格遵照 DEVELOPMENT_PLAN Section 3 的狀態機設計

### TODO / 技術債

- （無）

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | requirements.txt 包含所有依賴 | ✅ | streamlit, psycopg2-binary, pydantic, plotly, python-dotenv |
| 2 | docker-compose.yml PostgreSQL 服務正常 | ✅ | port 映射為 5433:5432（避免與 nexus-postgres 衝突） |
| 3 | .env.example 包含所有變數 | ✅ | DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD |
| 4 | .gitignore 涵蓋所有敏感檔案 | ✅ | .env, __pycache__/, *.pyc, data/, .DS_Store |
| 5 | constants.py 導出所有常數 | ✅ | 15 STATUS_CODES, 5 ACTION_TYPES, 3 INACTIVE_STATUSES, 15 VALID_TRANSITIONS |
| 6 | schema.sql 包含 8 張表 DDL | ✅ | 含 app_settings 初始資料 INSERT |
| 7 | connection.py 連線池可用 | ✅ | SimpleConnectionPool + get_connection() context manager |
| 8 | docker-compose up 成功 | ✅ | spms-postgres container running |
| 9 | init_db() 成功建表 | ✅ | 8 張表全部建立成功 |
| 10 | 所有 __init__.py 已建立 | ✅ | database/, models/, services/, pages/, components/ |

### 發現的問題

- Port 5432 被 nexus-postgres 佔用，改用 5433 映射

---

## Stage 4: Retrospective & Refactor

### 修復項目

- [x] Port 衝突：docker-compose 改用 5433 映射

### Retro: What went well

- 所有 8 張表一次到位，schema.sql 完全依照 DEVELOPMENT_PLAN Section 2
- constants.py 的 VALID_TRANSITIONS 完整覆蓋所有狀態
- connection.py 的 context manager 設計乾淨，auto commit/rollback
- init_db() 冪等執行（CREATE IF NOT EXISTS + ON CONFLICT DO NOTHING）

### Retro: What didn't go well

- Port 5432 衝突需手動排除（本機有其他 PostgreSQL 容器）

### Retro: Action items for next sprint

- [ ] S02 開始前確認 `get_connection()` 搭配 cursor 的使用模式穩定

### Retro: AI 協作筆記

- 有效的 prompt/context：提供 DEVELOPMENT_PLAN Section 1-3 + S01.md 的完整 DoD，AI 能精確實作
- 無效的 prompt/context：無

### Retro: 時間追蹤

- 預估時間：2.5 小時
- 實際時間：AI-assisted，約 10 分鐘
- 差異原因：AI 全自動實作，大幅加速

### Git Commit

- commit hash: `568cb82`
- message: `feat(S01): complete Infrastructure Foundation sprint`
