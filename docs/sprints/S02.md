# Sprint S02 — Data Layer

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S01（Infrastructure Foundation）

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S01（Infrastructure Foundation）
- [x] 確認 DB 連線正常（`docker-compose up -d` + `init_db()` 成功）
- [x] 確認 `constants.py` 常數可 import
- [x] 確認 `database/connection.py` 的 `get_connection()` 可用

### Sprint 目標宣告

> 完成資料層，讓所有 CRUD 可用

### 前置條件檢查

- [x] S01 已完成（狀態為 `completed`）
- [x] PostgreSQL 運行中（spms-postgres on port 5433）
- [x] 已閱讀 `docs/DEVELOPMENT_PLAN.md` Section 2-3

### Session 意圖

- 精神狀態：AI-assisted session
- 時間預算：Full sprint
- 特別注意事項：JSONB 處理需用 psycopg2.extras.Json()、狀態機驗證需嚴謹

---

## Stage 1: Sprint Planning

### User Stories

- [ ] **US-1**: 作為開發者，我希望 `models/schemas.py` 定義所有 Pydantic 模型（AnnualPlan, CRM, Project, SalesPlan, WorkLog, AppSetting），以便前端表單輸入有自動驗證
- [ ] **US-2**: 作為開發者，我希望 `services/annual_plan.py` 提供 CRUD（create, get_all, get_by_id, update, delete），以便年度戰略資料的讀寫
- [ ] **US-3**: 作為開發者，我希望 `services/crm.py` 提供 CRUD，並正確處理 JSONB 欄位（decision_maker, champion），以便客戶關係資料的讀寫
- [ ] **US-4**: 作為開發者，我希望 `services/project.py` 提供 CRUD + 狀態轉換函式 `transition_status(project_id, new_status)`，以便專案狀態只能按合法路徑流轉
- [ ] **US-5**: 作為開發者，我希望 `services/sales_plan.py` 提供 CRUD，以便商機預測資料的讀寫
- [ ] **US-6**: 作為開發者，我希望 `services/work_log.py` 提供 create + get_by_project + get_recent(limit=5)，以便工作日誌的寫入與查詢
- [ ] **US-7**: 作為開發者，我希望 `services/settings.py` 提供 get_all_headers() + update_header(key, value)，以便設定頁面自訂 Header

### Definition of Done（完成定義）

- [ ] `models/schemas.py` 定義 6+ 個 Pydantic BaseModel，欄位型別與 schema.sql 一致
- [ ] 每個 service 檔案提供完整 CRUD 函式，使用 psycopg2 原始 SQL（不使用 ORM）
- [ ] `services/project.py` 的 `transition_status()` 會驗證 VALID_TRANSITIONS，非法轉換拋出 ValueError
- [ ] `services/crm.py` 正確使用 `psycopg2.extras.Json()` 處理 JSONB 欄位
- [ ] `services/work_log.py` 的 `get_recent()` 回傳最近 N 筆紀錄（按 created_at DESC）
- [ ] `services/settings.py` 的 `get_all_headers()` 回傳 dict，key 為設定鍵、value 為設定值
- [ ] 所有 service 函式使用 `database/connection.py` 的 `get_connection()` 取得連線
- [ ] 可在 Python REPL 中成功呼叫每個 service 的 create 與 get 函式

### Context Files（AI 參考檔案）

開始此 Sprint 前，將以下檔案提供給 AI：
- `docs/DEVELOPMENT_PLAN.md` — Section 2（Schema）、Section 3（狀態機）
- `constants.py` — 狀態碼與動作類型
- `database/connection.py` — 連線池 API
- `database/schema.sql` — 資料表結構

---

## Stage 2: Vibe Coding

### 實作紀錄

> 在開發過程中記錄重要決策與遇到的問題。

- schemas.py 額外定義 DecisionMaker / Champion 子模型，方便 CRM JSONB 拆欄位
- crm.py 使用 `psycopg2.extras.Json()` 包裝 dict → JSONB 寫入
- project.py 的 `transition_status()` 先查詢當前狀態再驗證，兩步驟各自用 get_connection()
- work_log.py 的 `create()` 使用 `COALESCE(%s, CURRENT_DATE)` 讓 log_date 可選
- settings.py 的 `update_header()` 使用 `ON CONFLICT DO UPDATE` 實現 upsert

### TODO / 技術債

- （無）

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | schemas.py 定義 6+ Pydantic 模型 | ✅ | 8 models: AnnualPlan, CRM, DecisionMaker, Champion, Project, SalesPlan, WorkLog, AppSetting |
| 2 | 每個 service 提供完整 CRUD | ✅ | 6 service files, all with create/get_all/get_by_id/update/delete |
| 3 | project.py transition_status 驗證合法轉換 | ✅ | S01→S02 OK, S02→D03 blocked with ValueError |
| 4 | crm.py 正確處理 JSONB | ✅ | psycopg2.extras.Json() 寫入, dict 讀出 |
| 5 | work_log.py get_recent 回傳最近 N 筆 | ✅ | ORDER BY created_at DESC LIMIT N |
| 6 | settings.py get_all_headers 回傳 dict | ✅ | 6 keys returned |
| 7 | 所有 service 使用 get_connection() | ✅ | 全部 service 統一使用 connection pool |
| 8 | REPL 測試 create + get 成功 | ✅ | 所有 service 的 create + get 已驗證 |

### 發現的問題

- 無重大問題

---

## Stage 4: Retrospective & Refactor

### 修復項目

- （無需修復）

### Retro: What went well

- 所有 CRUD 一次通過 REPL 驗證
- JSONB 欄位的讀寫完整（dict → Json() → JSONB → dict）
- transition_status 正確阻擋非法狀態轉換
- schemas.py 額外定義 DecisionMaker/Champion 子模型，結構清晰

### Retro: What didn't go well

- 無重大問題

### Retro: Action items for next sprint

- [ ] S03 前端頁面需注意 FK 順序（先有 crm/annual_plan 才能建 project）

### Retro: AI 協作筆記

- 有效的 prompt/context：提供 schema.sql + constants.py + connection.py 三份檔案，AI 能精確對齊欄位與 API
- 無效的 prompt/context：無

### Retro: 時間追蹤

- 預估時間：3 小時
- 實際時間：AI-assisted，約 10 分鐘
- 差異原因：AI 全自動實作 + REPL 驗證

### Git Commit

- commit hash: `[待填入]`
- message: `[待填入]`
