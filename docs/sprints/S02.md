# Sprint S02 — Data Layer

> **狀態**: `pending`
> **預估時間**: 3 小時
> **前置 Sprint**: S01（Infrastructure Foundation）

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S01（Infrastructure Foundation）
- [ ] 確認 DB 連線正常（`docker-compose up -d` + `init_db()` 成功）
- [ ] 確認 `constants.py` 常數可 import
- [ ] 確認 `database/connection.py` 的 `get_connection()` 可用

### Sprint 目標宣告

> 完成資料層，讓所有 CRUD 可用

### 前置條件檢查

- [ ] S01 已完成（狀態為 `completed`）
- [ ] PostgreSQL 運行中（`docker-compose ps` 確認）
- [ ] 已閱讀 `docs/DEVELOPMENT_PLAN.md` Section 2-3

### Session 意圖

- 精神狀態：（Sprint 開始時填寫）
- 時間預算：（Sprint 開始時填寫）
- 特別注意事項：（Sprint 開始時填寫）

---

## Stage 1: Sprint Planning

### User Stories

- [ ] **US-1**: 作為開發者，我希望 `models/schemas.py` 定義所有 Pydantic 模型（AnnualPlan, CRM, Project, SalesPlan, WorkLog, AppSetting），以便前端表單輸入有自動驗證
- [ ] **US-2**: 作為開發者，我希望 `services/annual_plan.py` 提供 CRUD（create, get_all, get_by_id, update, delete），以便年度戰略資料的讀寫
- [ ] **US-3**: 作為開發者，我希望 `services/crm.py` 提供 CRUD，並正確處理 JSONB 欄位（decision_maker, champion），以便客戶關係資料的讀寫
- [ ] **US-4**: 作為開發者，我希望 `services/project.py` 提供 CRUD + 狀態轉換函式 `transition_status(project_id, new_status)`，以便專案狀態只能按合法路徑流轉
- [ ] **US-5**: 作為開發者，我希望 `services/sales_plan.py` 提供 CRUD，以便商機預測資料的讀寫
- [ ] **US-6**: 作為開發者，我希望 `services/work_log.py` 提供 create + get_by_project + get_recent(limit=5)，以便工作日誌的寫入與查詢
- [ ] **US-7**: 作為開發者，我希望 `services/settings.py` 提供 get_all_headers() + update_header(key, value)，以便設定頁面自訂 Header

### Definition of Done（完成定義）

- [ ] `models/schemas.py` 定義 6+ 個 Pydantic BaseModel，欄位型別與 schema.sql 一致
- [ ] 每個 service 檔案提供完整 CRUD 函式，使用 psycopg2 原始 SQL（不使用 ORM）
- [ ] `services/project.py` 的 `transition_status()` 會驗證 VALID_TRANSITIONS，非法轉換拋出 ValueError
- [ ] `services/crm.py` 正確使用 `psycopg2.extras.Json()` 處理 JSONB 欄位
- [ ] `services/work_log.py` 的 `get_recent()` 回傳最近 N 筆紀錄（按 created_at DESC）
- [ ] `services/settings.py` 的 `get_all_headers()` 回傳 dict，key 為設定鍵、value 為設定值
- [ ] 所有 service 函式使用 `database/connection.py` 的 `get_connection()` 取得連線
- [ ] 可在 Python REPL 中成功呼叫每個 service 的 create 與 get 函式

### Context Files（AI 參考檔案）

開始此 Sprint 前，將以下檔案提供給 AI：
- `docs/DEVELOPMENT_PLAN.md` — Section 2（Schema）、Section 3（狀態機）
- `constants.py` — 狀態碼與動作類型
- `database/connection.py` — 連線池 API
- `database/schema.sql` — 資料表結構

---

## Stage 2: Vibe Coding

### 實作紀錄

> 在開發過程中記錄重要決策與遇到的問題。

- （Sprint 開始後填寫）

### TODO / 技術債

- [ ] （Sprint 開始後填寫）

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | schemas.py 定義 6+ Pydantic 模型 | | |
| 2 | 每個 service 提供完整 CRUD | | |
| 3 | project.py transition_status 驗證合法轉換 | | |
| 4 | crm.py 正確處理 JSONB | | |
| 5 | work_log.py get_recent 回傳最近 N 筆 | | |
| 6 | settings.py get_all_headers 回傳 dict | | |
| 7 | 所有 service 使用 get_connection() | | |
| 8 | REPL 測試 create + get 成功 | | |

### 發現的問題

- （Review 後填寫）

---

## Stage 4: Retrospective & Refactor

### 修復項目

- [ ] （Retro 後填寫）

### Retro: What went well

- （Retro 後填寫）

### Retro: What didn't go well

- （Retro 後填寫）

### Retro: Action items for next sprint

- [ ] （Retro 後填寫）

### Retro: AI 協作筆記

- 有效的 prompt/context：（Retro 後填寫）
- 無效的 prompt/context：（Retro 後填寫）

### Retro: 時間追蹤

- 預估時間：3 小時
- 實際時間：（Sprint 結束後填寫）
- 差異原因：（Sprint 結束後填寫）

### Git Commit

- commit hash: `[填入]`
- message: `[填入]`
