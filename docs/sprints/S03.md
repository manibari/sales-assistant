# Sprint S03 — Core Pages

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S02（Data Layer）

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S02（Data Layer）
- [x] 確認 `services/*.py` 可呼叫（CRUD 函式正常）
- [x] 確認 `models/schemas.py` 的 Pydantic 模型可驗證
- [x] 確認 `services/project.py` 的 `transition_status()` 可正確驗證狀態轉換

### Sprint 目標宣告

> 做出核心頁面，能錄工作日誌和管理專案

### 前置條件檢查

- [x] S02 已完成（狀態為 `completed`）
- [x] 已閱讀 `docs/DEVELOPMENT_PLAN.md` Section 4（前端頁面設計）
- [x] 已閱讀 S02 的 Retro 教訓

### Session 意圖

- 精神狀態：AI-assisted session
- 時間預算：Full sprint
- 特別注意事項：Streamlit 頁面需注意 session_state 管理、下拉選單需過濾 INACTIVE_STATUSES

---

## Stage 1: Sprint Planning

### User Stories

- [ ] **US-1**: 作為業務人員，我希望在工作日誌頁面看到一個專案下拉選單（自動排除 D03/LOST/HOLD 的案件），以便快速選擇要紀錄的專案
- [ ] **US-2**: 作為業務人員，我希望在工作日誌頁面填寫日期、工時、工作類型、內容描述後按「送出」，資料即寫入資料庫，以便每日快速紀錄工作
- [ ] **US-3**: 作為業務人員，我希望送出工作日誌後，頁面下方立即顯示最近 5 筆紀錄（dataframe），以便確認紀錄成功
- [ ] **US-4**: 作為業務人員，我希望在專案管理頁面看到所有專案列表（st.dataframe），以便總覽所有案件狀態
- [ ] **US-5**: 作為業務人員，我希望在專案管理頁面新增/編輯專案（st.form），包含專案名稱、客戶、產品、負責人、優先級，以便維護專案資料
- [ ] **US-6**: 作為業務人員，我希望在專案管理頁面看到「狀態流轉」按鈕，且只顯示合法的下一步狀態（基於 VALID_TRANSITIONS），以便安全地推進案件狀態
- [ ] **US-7**: 作為開發者，我希望 `components/sidebar.py` 提供共用側邊欄元件，從 app_settings 讀取自訂 Header 並顯示導航連結，以便所有頁面共用一致的導航

### Definition of Done（完成定義）

- [ ] `pages/work_log.py` 包含專案下拉選單，格式為 `[狀態碼] 專案名稱`，已過濾非活躍專案
- [ ] 工作日誌表單包含：日期（date_input, 預設今天）、工時（number_input, 預設 1.0, 步進 0.5）、工作類型（selectbox）、內容（text_area）
- [ ] 送出後下方顯示最近 5 筆紀錄的 st.dataframe
- [ ] `pages/project.py` 上方顯示專案列表 st.dataframe
- [ ] 專案新增/編輯表單包含所有必要欄位，客戶與產品為下拉選單（從 DB 讀取）
- [ ] 狀態流轉 UI 只顯示合法的下一步狀態 + LOST/HOLD 選項
- [ ] `components/sidebar.py` 從 app_settings 讀取 Header，提供導航功能
- [ ] 頁面在 `streamlit run` 後可正常顯示（無 Python error）

### Context Files（AI 參考檔案）

開始此 Sprint 前，將以下檔案提供給 AI：
- `docs/DEVELOPMENT_PLAN.md` — Section 4（前端頁面設計）
- `constants.py` — 狀態碼、動作類型、非活躍狀態、合法轉換
- `services/work_log.py` — 工作日誌 CRUD API
- `services/project.py` — 專案 CRUD + 狀態轉換 API
- `services/settings.py` — 設定 CRUD API
- `models/schemas.py` — Pydantic 模型

---

## Stage 2: Vibe Coding

### 實作紀錄

> 在開發過程中記錄重要決策與遇到的問題。

- sidebar.py 使用 `st.page_link()` 實現導航，從 app_settings 動態讀取 Header
- work_log.py 使用 `st.form(clear_on_submit=True)` 讓送出後自動清空表單
- work_log.py 的專案下拉選單用 `format_func` 顯示 `[狀態碼] 專案名稱` 格式
- project.py 使用 tabs 分離新增/編輯/狀態流轉三個操作區
- project.py 的編輯表單會預填現有資料（client_id/product_id 用 index 定位）
- project.py 狀態流轉 UI 顯示 `狀態碼 — 中文名稱` 格式

### TODO / 技術債

- （無）

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | 工作日誌專案下拉選單正確過濾 | ✅ | INACTIVE_STATUSES (D03/LOST/HOLD) 已過濾 |
| 2 | 工作日誌表單欄位完整 | ✅ | date_input, number_input(0.5步進), selectbox, text_area |
| 3 | 送出後顯示最近 5 筆 | ✅ | pd.DataFrame + st.dataframe |
| 4 | 專案列表 dataframe 顯示 | ✅ | st.dataframe(use_container_width=True) |
| 5 | 專案新增/編輯表單完整 | ✅ | 名稱/客戶/產品(下拉)/負責人/優先級，編輯預填現有值 |
| 6 | 狀態流轉只顯示合法選項 | ✅ | VALID_TRANSITIONS 驅動，終態顯示警告 |
| 7 | sidebar 導航功能正常 | ✅ | st.page_link + 動態 Header |
| 8 | streamlit run 無錯誤 | ✅ | Streamlit 啟動無 Python error |

### 發現的問題

- 無重大問題

---

## Stage 4: Retrospective & Refactor

### 修復項目

- （無需修復）

### Retro: What went well

- Streamlit 頁面一次啟動成功，無 Python error
- sidebar 動態 Header + page_link 導航設計乾淨
- project.py 的 tabs 設計讓三種操作（新增/編輯/流轉）互不干擾
- work_log.py 的 clear_on_submit 讓表單送出體驗流暢

### Retro: What didn't go well

- 無重大問題

### Retro: Action items for next sprint

- [ ] S04 的三個頁面可複用 S03 的 CRUD 頁面模式（上方 dataframe + 下方 form）

### Retro: AI 協作筆記

- 有效的 prompt/context：DEVELOPMENT_PLAN Section 4 的頁面設計規格 + services API 簽名
- 無效的 prompt/context：無

### Retro: 時間追蹤

- 預估時間：3 小時
- 實際時間：AI-assisted，約 10 分鐘
- 差異原因：AI 全自動實作 + Streamlit smoke test

### Git Commit

- commit hash: `[待填入]`
- message: `[待填入]`
