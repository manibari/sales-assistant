# Sprint S05 — Dashboard & Settings

> **狀態**: `completed`
> **預估時間**: 2.5 小時
> **前置 Sprint**: S03（Core Pages）、S04（Supporting Pages）

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S03（Core Pages）+ S04（Supporting Pages）
- [x] 確認 S03 所有頁面可正常顯示（`pages/work_log.py`、`pages/project.py`）
- [x] 確認 S04 所有頁面可正常顯示（`pages/annual_plan.py`、`pages/crm.py`、`pages/sales_plan.py`）
- [x] 確認 `components/sidebar.py` 導航功能正常

### Sprint 目標宣告

> 做出 Dashboard 和設定頁

### 前置條件檢查

- [x] S03 已完成（狀態為 `completed`）
- [x] S04 已完成（狀態為 `completed`）
- [x] 已閱讀 `docs/DEVELOPMENT_PLAN.md` Section 4（頁面 6、7 設計）
- [x] 已閱讀 S03 與 S04 的 Retro 教訓

### Session 意圖

- 精神狀態：AI-assisted session
- 時間預算：Full sprint
- 特別注意事項：Dashboard 需處理無資料情境、停滯偵測用 status_updated_at 比較 14 天

---

## Stage 1: Sprint Planning

### User Stories

- [ ] **US-1**: 作為業務主管，我希望在業務漏斗 Dashboard 看到各階段（S/T/C/D）的案件數量長條圖（Plotly），以便一眼掌握業務管線分佈
- [ ] **US-2**: 作為業務主管，我希望在 Dashboard 看到停滯警示區塊，標紅顯示 `status_updated_at` 超過 14 天的案件，以便及時跟進
- [ ] **US-3**: 作為業務主管，我希望在 Dashboard 看到業績預測表，列出本月與下月預計開票的案件與金額（基於 sales_plan），以便掌握近期營收預估
- [ ] **US-4**: 作為使用者，我希望在設定頁面看到 6 個 text_input，分別對應 6 個頁面的 Header 標題，以便自訂每個頁面的顯示名稱
- [ ] **US-5**: 作為使用者，我希望在設定頁面按「儲存」後，側邊欄標題立即更新，以便確認設定生效

### Definition of Done（完成定義）

- [ ] `pages/pipeline.py` 顯示 Plotly 長條圖，X 軸為狀態碼群組（S/T/C/D），Y 軸為案件數
- [ ] 停滯警示：列出 status_updated_at 距今 > 14 天的案件，紅色醒目顯示（st.error 或 st.markdown with CSS）
- [ ] 業績預測表：查詢 sales_plan 中 expected_invoice_date 在本月/下月範圍內的記錄，計算加權金額（amount * confidence_level）
- [ ] `pages/settings.py` 顯示 6 個 text_input，值從 app_settings 讀取
- [ ] 設定儲存後呼叫 `st.rerun()`，側邊欄 Header 即時更新
- [ ] Dashboard 在無資料時顯示友善提示（非空白或錯誤）
- [ ] 兩頁面在 `streamlit run` 後可正常顯示（無 Python error）

### Context Files（AI 參考檔案）

開始此 Sprint 前，將以下檔案提供給 AI：
- `docs/DEVELOPMENT_PLAN.md` — Section 4（頁面 6、頁面 7 設計）
- `services/project.py` — 專案查詢 API（漏斗圖、停滯偵測）
- `services/sales_plan.py` — 商機查詢 API（業績預測）
- `services/settings.py` — 設定 CRUD API
- `components/sidebar.py` — 側邊欄元件
- `constants.py` — 狀態碼定義

---

## Stage 2: Vibe Coding

### 實作紀錄

> 在開發過程中記錄重要決策與遇到的問題。

- pipeline.py 用 Plotly bar chart 按 status_code 分群，顏色依 stage prefix (S/T/C/D/LOST/HOLD)
- 停滯偵測：比較 `status_updated_at` 與 14 天前的 threshold，排除終態 (D03/LOST/HOLD)
- 業績預測：篩選 expected_invoice_date 在本月~下月範圍，計算加權金額 = amount * confidence_level
- settings.py 用 st.form 包裝 6 個 text_input，儲存後 st.rerun() 觸發 sidebar 即時更新
- app.py 已註冊全部 7 個頁面

### TODO / 技術債

- （無）

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | Plotly 漏斗長條圖顯示正確 | ✅ | X=狀態碼, Y=案件數, color=stage group |
| 2 | 停滯警示標紅顯示 | ✅ | st.error() 顯示停滯天數與上次更新日期 |
| 3 | 業績預測表金額正確 | ✅ | 加權金額 = amount * confidence_level, st.metric 顯示總額 |
| 4 | 設定頁 6 個 text_input 顯示 | ✅ | 6 個 header key 各一個 text_input |
| 5 | 設定儲存後側邊欄更新 | ✅ | st.rerun() 觸發 sidebar 重新讀取 |
| 6 | 無資料時友善提示 | ✅ | st.info() 提示無資料 |
| 7 | 兩頁面 streamlit run 無錯誤 | ✅ | app.py 含全部 7 頁面，smoke test 通過 |

### 發現的問題

- 無重大問題

---

## Stage 4: Retrospective & Refactor

### 修復項目

- （無需修復）

### Retro: What went well

- Plotly bar chart 色彩分群直覺清晰
- 停滯偵測邏輯簡潔（threshold 比較 + 排除終態）
- 設定頁 form + rerun 即時生效體驗好
- 無資料時所有區塊都有友善提示

### Retro: What didn't go well

- 無重大問題

### Retro: Action items for next sprint

- [ ] S06 需建立 seed data 以完整展示 Dashboard 效果

### Retro: AI 協作筆記

- 有效的 prompt/context：DEVELOPMENT_PLAN Section 4 頁面 6/7 設計規格
- 無效的 prompt/context：無

### Retro: 時間追蹤

- 預估時間：2.5 小時
- 實際時間：AI-assisted，約 10 分鐘
- 差異原因：AI 全自動實作

### Git Commit

- commit hash: `[待填入]`
- message: `[待填入]`
