# Sprint S06 — Integration & Polish

> **狀態**: `completed`
> **預估時間**: 2.5 小時
> **前置 Sprint**: S05（Dashboard & Settings）

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S05（Dashboard & Settings）
- [x] 確認所有獨立頁面可正常顯示（7 個頁面全部 `streamlit run` 無錯誤）
- [x] 確認 Dashboard 漏斗圖、停滯警示、業績預測功能正常
- [x] 確認設定頁可修改 Header 且側邊欄即時更新

### Sprint 目標宣告

> 整合所有頁面，跑通端到端驗證

### 前置條件檢查

- [x] S05 已完成（狀態為 `completed`）
- [x] 已閱讀 `docs/DEVELOPMENT_PLAN.md` Section 4（導航架構）、Section 8（驗證方式）
- [x] 已閱讀 S03 ~ S05 所有 Retro 教訓

### Session 意圖

- 精神狀態：AI-assisted session
- 時間預算：Full sprint
- 特別注意事項：最終 Sprint，seed.py 需冪等、app.py 需動態 Header、E2E 驗證需完整

---

## Stage 1: Sprint Planning

### User Stories

- [ ] **US-1**: 作為使用者，我希望 `app.py` 整合所有 7 個頁面，使用 `st.navigation()` API 統一管理導航，以便從單一入口存取所有功能
- [ ] **US-2**: 作為使用者，我希望啟動 app 時自動初始化資料庫（呼叫 init_db()），若表不存在則自動建立，以便無需手動執行 SQL
- [ ] **US-3**: 作為開發者，我希望 `database/seed.py` 提供示範資料（2 個產品、3 個客戶、5 個專案、10 筆工作日誌、3 筆商機），以便快速驗證系統功能
- [ ] **US-4**: 作為使用者，我希望執行 `python database/seed.py` 即可載入示範資料，且重複執行不會產生重複資料（使用 ON CONFLICT DO NOTHING 或先清空再寫入），以便隨時重置測試環境
- [ ] **US-5**: 作為開發者，我希望進行端到端驗證：從 docker-compose up → streamlit run → 操作所有 7 個頁面 → 確認資料正確流動，以便確保 Phase 1 整體可用

### Definition of Done（完成定義）

- [ ] `app.py` 使用 `st.navigation()` 定義 7 個頁面，頁面標題從 app_settings 動態讀取
- [ ] app.py 啟動時呼叫 `init_db()` 確保資料表存在
- [ ] `database/seed.py` 包含完整的示範資料，涵蓋所有資料表（annual_plan, crm, project_list, sales_plan, work_log）
- [ ] seed.py 可安全重複執行（不產生重複資料）
- [ ] 端到端驗證通過（DEVELOPMENT_PLAN.md Section 8 的 Phase 1 驗證 8 項全部通過）：
  - docker-compose up -d 啟動 PostgreSQL
  - streamlit run app.py 啟動應用
  - 8 張表存在
  - 設定頁修改 Header → 側邊欄即時更新
  - 新增專案 → 工作日誌下拉選單出現
  - 新增工作日誌 → 最近 5 筆正確
  - 狀態流轉 → 只顯示合法下一步
  - Dashboard 漏斗圖正確

### Context Files（AI 參考檔案）

開始此 Sprint 前，將以下檔案提供給 AI：
- `docs/DEVELOPMENT_PLAN.md` — Section 4（導航架構）、Section 8（驗證方式）
- `app.py`（如有草稿版本）
- `database/connection.py` — init_db() API
- `database/schema.sql` — 完整 DDL
- `services/*.py` — 所有 service 的 API（了解可用函式）
- `pages/*.py` — 所有頁面（了解頁面結構）
- `components/sidebar.py` — 側邊欄元件

---

## Stage 2: Vibe Coding

### 實作紀錄

> 在開發過程中記錄重要決策與遇到的問題。

- app.py 升級為從 app_settings 動態讀取頁面標題
- seed.py 使用「先清空再寫入」策略確保冪等，序列也重置
- seed.py 的 sys.path.insert 確保直接 `python database/seed.py` 可執行
- 示範資料設計：包含一個停滯案件(20天)、一個終態案件(D03)，方便 Dashboard 展示
- 商機的 expected_invoice_date 設為相對日期（today + N days），確保預測表永遠有資料

### TODO / 技術債

- （無）

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | app.py 使用 st.navigation() 整合 7 頁面 | ✅ | 動態讀取 app_settings 標題 |
| 2 | 啟動時自動 init_db() | ✅ | app.py 第一行呼叫 |
| 3 | seed.py 示範資料完整 | ✅ | 2 產品 + 3 客戶 + 5 專案 + 10 日誌 + 3 商機 |
| 4 | seed.py 可重複執行 | ✅ | 先清空再寫入，序列重置 |
| 5 | E2E: docker-compose up 成功 | ✅ | spms-postgres on port 5433 |
| 6 | E2E: streamlit run 成功 | ✅ | 7 頁面全部載入無錯誤 |
| 7 | E2E: 設定頁 Header 即時更新 | ✅ | settings.get_all_headers() + st.rerun() |
| 8 | E2E: 新增專案 → 工作日誌選單 | ✅ | 4 active projects (D03 filtered) |
| 9 | E2E: 工作日誌最近 5 筆 | ✅ | get_recent(5) returns 5 rows |
| 10 | E2E: 狀態流轉合法性 | ✅ | S01→S02 OK, illegal transitions blocked |
| 11 | E2E: Dashboard 漏斗圖 | ✅ | 1 stagnant project detected (台積電 AI 客服導入案, 20 days) |

### 發現的問題

- 無重大問題

---

## Stage 4: Retrospective & Refactor

### 修復項目

- （無需修復）

### Retro: What went well

- seed.py 冪等設計可靠，重複執行無副作用
- 示範資料設計充分展示各種情境（停滯/終態/多階段）
- E2E 11 項驗證全部一次通過
- Phase 1 全部 6 個 Sprint 完成，系統可用

### Retro: What didn't go well

- 無重大問題

### Retro: Action items for next sprint

- [ ] Phase 2 可考慮加入匯出功能、進階篩選
- [ ] Phase 3 AI Agent 開發

### Retro: AI 協作筆記

- 有效的 prompt/context：DEVELOPMENT_PLAN Section 8 的驗證清單作為 E2E checklist
- 無效的 prompt/context：無

### Retro: 時間追蹤

- 預估時間：2.5 小時
- 實際時間：AI-assisted，約 10 分鐘
- 差異原因：AI 全自動實作 + E2E 程式化驗證

### Git Commit

- commit hash: `[待填入]`
- message: `[待填入]`
