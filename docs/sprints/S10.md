# Sprint S10 — DB 正規化（Contact 獨立表）

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S09

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S09 — Work Log Split + Postsale Detail
- 完成狀態: ✅ 已完成（工作日誌分頁、售後專案明細含 task CRUD / Gantt / Burndown）

### Sprint 目標宣告

> 將 CRM 表的 JSONB 聯絡人資料正規化為獨立的 `contact` + `account_contact` 表，採雙寫策略確保向後相容。

### 前置條件檢查

- [x] S09 已完成
- [x] CRM 表已有 `champions` (array) + `decision_maker` JSONB 欄位
- [x] Retro 文件同步 + Bug 修復已完成

### Session 意圖

- 精神狀態：（Sprint 開始時填寫）
- 時間預算：3 小時
- 特別注意事項：雙寫策略需確保 page 層無感

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1**: 作為開發者，我希望聯絡人資料存在獨立的正規化表中，以便未來實現跨客戶聯絡人搜尋
- [x] **US-2**: 作為使用者，我希望 CRM 頁面功能不變，以便無縫升級
- [x] **US-3**: 作為開發者，我希望 migration 可冪等執行，以便安全地重複運行

### Definition of Done（完成定義）

- [x] DoD-1: `contact` + `account_contact` 表已建立
- [x] DoD-2: `migrate_s10.py` 可冪等執行，JSONB 資料正確遷移
- [x] DoD-3: `services/contact.py` 提供完整 CRUD + link/unlink
- [x] DoD-4: `services/crm.py` 雙寫邏輯：create/update 同時寫入正規化表 + JSONB
- [x] DoD-5: CRM 頁面 4 tab 功能不變
- [x] DoD-6: 文件已更新（CLAUDE.md, DEVELOPMENT_PLAN.md, schema.sql）

### Context Files（AI 參考檔案）

- `docs/DEVELOPMENT_PLAN.md`
- `database/schema.sql`
- `services/crm.py`
- `pages/crm.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

- 新建 `contact` + `account_contact` CREATE TABLE 於 schema.sql
- 新建 `database/migrate_s10.py`：冪等遷移 JSONB → 正規化表
- 新建 `services/contact.py`：完整 CRUD + link/unlink
- 修改 `services/crm.py`：create/update 加入雙寫邏輯，get_by_id 優先讀正規化表
- 同步更新 CLAUDE.md, DEVELOPMENT_PLAN.md

### TODO / 技術債

- [ ] S11: 聯絡人獨立管理頁面
- [ ] S11+: 確認穩定後考慮移除 JSONB 欄位

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | contact + account_contact 表已建立 | ✅ | schema.sql + migrate_s10.py |
| 2 | migrate_s10.py 冪等執行 | ✅ | 重複檢測 by (name, email, client_id) |
| 3 | services/contact.py CRUD | ✅ | 7 個函數 |
| 4 | services/crm.py 雙寫 | ✅ | create/update 同步 |
| 5 | CRM 頁面功能不變 | ✅ | Streamlit 啟動正常，get_by_id 讀正規化表、雙寫 create/update 驗證通過 |
| 6 | 文件已更新 | ✅ | |

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無需修復

### Retro: What went well

- 雙寫策略讓 page 層完全無感
- Migration 的重複檢測機制設計合理
- 冪等性驗證：第二次執行 0 新增、73 跳過
- 雙寫 create/update 測試一次通過

### Retro: What didn't go well

- S07-S09 的變更長期未提交，累積了大量 diff

### Retro: Action items for next sprint

- [ ] S11: 建立聯絡人獨立管理頁面，跨客戶搜尋
- [ ] 確認雙寫穩定後，規劃移除 JSONB 欄位

### Retro: AI 協作筆記

- 有效的 prompt/context：提供完整 schema + service 代碼 + migration pattern
- 無效的 prompt/context：無

### Retro: 時間追蹤

- 預估時間：3 小時
- 實際時間：~1 小時
- 差異原因：Retro 階段已完成文件同步與代碼撰寫，S10 執行主要是 migration + 驗證
