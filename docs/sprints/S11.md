# Sprint S11 — 階段機率 + Deal-Contact + 售前詳情頁

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S10

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S10 — DB 正規化（Contact 獨立表）
- 完成狀態: ✅ 已完成（contact + account_contact 正規化表、雙寫策略、migration 冪等驗證）

### Sprint 目標宣告

> 建立階段機率機制、專案-聯絡人關聯功能、以及售前專案詳情頁，強化售前管理的資訊深度與操作體驗。

### 前置條件檢查

- [x] S10 已完成（contact + account_contact 表已建立）
- [x] 狀態機與常數定義穩定
- [x] 環境就緒（PostgreSQL + Streamlit）

### Session 意圖

- 精神狀態：專注
- 時間預算：3 小時
- 特別注意事項：階段機率需覆蓋所有 13 個狀態碼；售前詳情頁為新頁面，需整合多種功能

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1**: 作為業務人員，我希望每個售前階段有預設的成交機率，以便在新增商機預測時自動帶入合理的信心指數
- [x] **US-2**: 作為業務人員，我希望能將聯絡人關聯到特定專案，以便追蹤每個案件的關鍵利害關係人
- [x] **US-3**: 作為業務人員，我希望有售前專案詳情頁，以便在同一頁面查看案件的完整資訊（狀態、聯絡人、商機、活動紀錄）

### Definition of Done（完成定義）

- [x] DoD-1: `stage_probability` 表已建立，含 13 個狀態碼的預設機率
- [x] DoD-2: `project_contact` 表已建立，支援專案-聯絡人多對多關聯
- [x] DoD-3: `services/stage_probability.py` 提供 get_all / get_by_code / update
- [x] DoD-4: `services/project.py` 新增 link_contact / unlink_contact / get_contacts
- [x] DoD-5: `pages/presale_detail.py` 售前詳情頁可正常運作（狀態流轉、聯絡人管理、商機同步）
- [x] DoD-6: `pages/sales_plan.py` 新增商機時自動帶入階段機率作為信心指數預設值

### Context Files（AI 參考檔案）

- `docs/DEVELOPMENT_PLAN.md` — 總體架構參考
- `database/schema.sql` — Schema 定義
- `services/project.py` — 專案 CRUD + 狀態機
- `services/contact.py` — 聯絡人 CRUD
- `constants.py` — 狀態碼定義

---

## Stage 2: Vibe Coding

### 實作紀錄

- 新建 `database/migrate_s11.py`：建立 `stage_probability`（13 筆種子資料）+ `project_contact` 表
- 新建 `services/stage_probability.py`：get_all / get_by_code / update
- 新建 `pages/presale_detail.py`：售前專案詳情頁（含狀態流轉、關聯聯絡人、商機預測、活動時間軸 tab）
- 修改 `database/schema.sql`：加入 stage_probability + project_contact DDL
- 修改 `constants.py`：新增 CONTACT_ROLES + DEFAULT_STAGE_PROBABILITIES
- 修改 `services/project.py`：新增 link_contact / unlink_contact / get_contacts
- 修改 `pages/presale.py`：加入「查看詳情」按鈕導向 presale_detail.py
- 修改 `pages/sales_plan.py`：新增商機時自動帶入階段機率預填
- 修改 `pages/settings.py`：新增階段機率設定 UI（13 個 slider）
- 修改 `app.py`：註冊 presale_detail.py 頁面

### TODO / 技術債

- [ ] S12: 加入 due_date / is_next_action 至 project_task

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | stage_probability 表含 13 筆 | ✅ | L0-L7, P0-P2, LOST, HOLD |
| 2 | project_contact 表支援多對多 | ✅ | PK (project_id, contact_id) + ON DELETE CASCADE |
| 3 | stage_probability service | ✅ | get_all / get_by_code / update |
| 4 | project.py contact 功能 | ✅ | link / unlink / get_contacts |
| 5 | presale_detail.py 正常運作 | ✅ | 4 個 tab 全部可操作 |
| 6 | sales_plan.py 機率預填 | ✅ | 選擇專案後自動帶入對應階段機率 |

### 發現的問題

- 無重大問題

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無需修復

### Retro: What went well

- stage_probability 的種子資料設計合理（L0=5% 遞增至 L7=100%）
- presale_detail.py 將多種功能整合到單一詳情頁，大幅提升操作效率
- project_contact 複用 S10 的 contact 表，避免重複設計

### Retro: What didn't go well

- **跳過了 Sprint 五階段流程**：S11-S13 一次性開發，沒有逐一 Kickoff/Review/Retro
- 沒有在開發前建立 Sprint 文件
- DEVELOPMENT_PLAN.md 的 S11 描述（Contact UI 整合）與實際實作（階段機率 + 售前詳情頁）完全不同

### Retro: Action items for next sprint

- [x] 補建 S11/S12/S13 Sprint 文件
- [x] 更新 DEVELOPMENT_PLAN.md 使其與實際實作一致
- [ ] 未來嚴格遵循五階段流程，不再跳過

### Retro: AI 協作筆記

- 有效的 prompt/context：提供完整 schema + constants + 現有 service pattern
- 無效的 prompt/context：無
- 教訓：即使 AI 協作效率高，流程紀律仍不可省略

### Retro: 時間追蹤

- 預估時間：3 小時
- 實際時間：~2 小時（含 S12/S13 共同開發時間，無法精確拆分）
- 差異原因：三個 Sprint 一次性完成，時間界線模糊

### Git Commit

- commit hash: `（補救 commit）`
- message: `feat(S11): stage probability + project-contact + presale detail`
