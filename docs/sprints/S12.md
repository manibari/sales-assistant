# Sprint S12 — 活動時間軸 + 售前任務 + 下一步行動

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S11

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S11 — 階段機率 + Deal-Contact + 售前詳情頁
- 完成狀態: ✅ 已完成（stage_probability、project_contact、presale_detail.py、機率預填）

### Sprint 目標宣告

> 為任務管理加入截止日期與下一步行動標記，建立今日待辦提醒與逾期警示，強化日常工作的時效追蹤。

### 前置條件檢查

- [x] S11 已完成（presale_detail.py 已有任務管理 tab）
- [x] project_task 表已存在
- [x] 環境就緒

### Session 意圖

- 精神狀態：專注
- 時間預算：3 小時
- 特別注意事項：due_date / is_next_action 需同步更新至 presale_detail.py 和 postsale_detail.py

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1**: 作為業務人員，我希望任務有截止日期和「下一步行動」標記，以便快速辨識優先事項
- [x] **US-2**: 作為業務人員，我希望在工作日誌頁看到今日待辦提醒，以便每天開工時掌握優先任務
- [x] **US-3**: 作為主管，我希望在業務漏斗頁看到逾期待辦清單，以便及時介入處理延遲的任務

### Definition of Done（完成定義）

- [x] DoD-1: `project_task` 表新增 `due_date` + `is_next_action` 欄位
- [x] DoD-2: `services/project_task.py` 新增 `get_upcoming()` 查詢即將到期/逾期任務
- [x] DoD-3: `pages/work_log.py` 顯示今日待辦提醒
- [x] DoD-4: `pages/pipeline.py` 顯示逾期待辦清單
- [x] DoD-5: `pages/postsale_detail.py` 任務表單包含 due_date / is_next_action
- [x] DoD-6: `pages/presale_detail.py` 任務管理 tab 顯示下一步行動高亮

### Context Files（AI 參考檔案）

- `services/project_task.py` — 任務 CRUD
- `pages/presale_detail.py` — 售前詳情頁
- `pages/postsale_detail.py` — 售後詳情頁
- `pages/pipeline.py` — 業務漏斗
- `pages/work_log.py` — 工作日誌

---

## Stage 2: Vibe Coding

### 實作紀錄

- 新建 `database/migrate_s12.py`：ALTER TABLE project_task ADD COLUMN due_date / is_next_action
- 修改 `database/schema.sql`：project_task 加入 due_date (DATE) + is_next_action (BOOLEAN DEFAULT FALSE)
- 修改 `services/project_task.py`：create/update 支援 due_date + is_next_action；新增 get_upcoming(days) 查詢
- 修改 `services/work_log.py`：新增 get_by_client(client_id) 查詢客戶下所有專案的工作日誌
- 修改 `pages/work_log.py`：頁面頂部加入「今日待辦提醒」區塊
- 修改 `pages/pipeline.py`：新增「逾期待辦」區塊
- 修改 `pages/postsale_detail.py`：任務表單加入 due_date / is_next_action 欄位
- 修改 `pages/presale_detail.py`：任務管理 tab 中高亮顯示 is_next_action 任務
- 修改 `pages/crm.py`：客戶詳情加入「近期活動」摘要（使用 get_by_client）

### TODO / 技術債

- [ ] S13: 全域搜尋 + Visual Board

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | project_task 新欄位 | ✅ | due_date DATE + is_next_action BOOLEAN |
| 2 | get_upcoming() | ✅ | 查詢未完成且有 due_date 的任務 |
| 3 | 今日待辦提醒 | ✅ | work_log.py 頁面頂部顯示 |
| 4 | 逾期待辦清單 | ✅ | pipeline.py 逾期區塊 |
| 5 | postsale_detail 表單 | ✅ | due_date + is_next_action 欄位 |
| 6 | presale_detail 高亮 | ✅ | is_next_action 任務以 warning box 顯示 |

### 發現的問題

- 無重大問題

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無需修復

### Retro: What went well

- get_upcoming() 設計靈活：days=0 可查逾期、days=7 可查本週待辦
- 今日待辦提醒提升了工作日誌頁的實用性
- get_by_client() 為 CRM 頁提供了跨專案活動摘要

### Retro: What didn't go well

- 與 S11 同時開發，沒有獨立的 Sprint 流程
- presale_detail.py 和 schema.sql 的 S12 變更與 S11 混在同一檔案，無法完全拆分 commit

### Retro: Action items for next sprint

- [x] 補建 Sprint 文件
- [ ] 未來每個 Sprint 獨立 commit

### Retro: AI 協作筆記

- 有效的 prompt/context：提供 project_task service + 頁面現有結構
- 無效的 prompt/context：無

### Retro: 時間追蹤

- 預估時間：3 小時
- 實際時間：~1.5 小時（與 S11/S13 共同開發，無法精確拆分）
- 差異原因：三個 Sprint 一次性完成

### Git Commit

- commit hash: `（補救 commit）`
- message: `feat(S12): activity timeline + presale tasks + next action`
