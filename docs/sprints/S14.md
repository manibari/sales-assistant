# Sprint S14 — 客戶層級活動記錄

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S13

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S13 — 全域搜尋 + Visual Board
- 完成狀態: ✅ 已完成（search_all() 跨表搜尋、售前看板 L0-L6）

### Sprint 目標宣告

> 讓業務人員可以記錄不綁定專案的客戶活動（如初次拜訪、電話開發），解決 work_log.project_id NOT NULL 的限制。

### 前置條件檢查

- [x] S13 已完成
- [x] work_log 表結構已穩定
- [x] 環境就緒

### Session 意圖

- 精神狀態：專注
- 時間預算：3 小時
- 特別注意事項：work_log schema 變更影響範圍廣，需確認所有相關頁面和服務都正常

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1**: 作為業務人員，我希望能記錄不綁定專案的客戶活動，以便在建案前就追蹤互動
- [x] **US-2**: 作為業務人員，我希望在工作日誌頁切換「專案活動」/「客戶活動」模式
- [x] **US-3**: 作為主管，我希望在 CRM 詳情頁同時看到專案級和客戶級活動

### Definition of Done（完成定義）

- [x] DoD-1: `migrate_s14.py` — `project_id` 改 nullable + 新增 `client_id FK` + CHECK 約束
- [x] DoD-2: `schema.sql` — work_log DDL 同步更新
- [x] DoD-3: `services/work_log.py` — `create()` 支援 optional `client_id`；`get_by_client()` UNION 兩種來源
- [x] DoD-4: `models/schemas.py` — `WorkLog.project_id` 改 `Optional[int]`，新增 `client_id: Optional[str]`
- [x] DoD-5: `pages/work_log.py` — radio toggle「專案活動」vs「客戶活動」，切換不同 selector
- [x] DoD-6: `pages/crm.py` — 近期活動合併顯示兩種日誌，加標記區分

### Context Files（AI 參考檔案）

- `database/schema.sql` — work_log 表結構
- `services/work_log.py` — 現有 CRUD
- `pages/work_log.py` — 現有工作日誌頁面
- `pages/crm.py` — CRM 詳情頁近期活動

---

## Stage 2: Vibe Coding

### 實作紀錄

- 新建 `database/migrate_s14.py`：ALTER TABLE work_log（nullable project_id + client_id FK + CHECK constraint）
- 修改 `database/schema.sql`：work_log DDL 更新（project_id nullable, client_id 新增, CHECK constraint）
- 修改 `models/schemas.py`：WorkLog.project_id → Optional[int], 新增 client_id: Optional[str]
- 修改 `services/work_log.py`：create() 支援 client_id 參數；get_by_client() 改 UNION（project + client scope）；新增 get_client_only()
- 修改 `pages/work_log.py`：新增 radio toggle（專案活動/客戶活動），客戶活動有獨立表單和 client selector
- 修改 `pages/crm.py`：近期活動合併顯示，以 :green[客戶] / :blue[專案] 標籤區分來源

### TODO / 技術債

- (無)

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | migrate_s14.py 正確執行 | ✅ | nullable project_id + client_id FK + CHECK |
| 2 | schema.sql 同步更新 | ✅ | work_log DDL 含 client_id + constraint |
| 3 | services/work_log.py 支援 client_id | ✅ | create() + get_by_client() UNION |
| 4 | WorkLog model 更新 | ✅ | project_id Optional, client_id Optional |
| 5 | work_log 頁面 radio toggle | ✅ | 專案/客戶活動切換 |
| 6 | CRM 詳情頁合併活動 | ✅ | log_scope 標籤區分 |

### 發現的問題

- 無重大問題

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無需修復

### Retro: What went well

- UNION 查詢設計簡潔，一次取回兩種來源的活動
- radio toggle UX 直觀，不需要新增獨立頁面
- CHECK constraint 確保資料完整性（至少一個 scope）

### Retro: What didn't go well

- 初次實作時跳過了 Sprint 五階段流程，後續補建文件

### Retro: Action items for next sprint

- [x] S15 需確認 work_log client_id 與營收查詢的整合
- [x] 恢復正常五階段 Sprint 流程

### Retro: AI 協作筆記

- 有效的 prompt/context：提供完整的 work_log 現有 schema + service 程式碼
- 教訓：schema 變更應先建立 migration，確認不影響現有資料

### Retro: 時間追蹤

- 預估時間：3 小時
- 實際時間：~1 小時
- 差異原因：變更範圍集中，無意外阻塞

### Git Commit

- commit hash: `（待 commit）`
- message: `feat(S14): client-level activity records`
