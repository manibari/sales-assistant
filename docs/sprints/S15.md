# Sprint S15 — 客戶營收彙總 + JSONB 退場

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S14

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S14 — 客戶層級活動記錄
- 完成狀態: ✅ 已完成（nullable project_id、client_id FK、UNION 查詢、radio toggle）

### Sprint 目標宣告

> 為 CRM 詳情頁加入營收彙總指標，並將 JSONB 雙寫退場，統一改為正規化表讀寫。

### 前置條件檢查

- [x] S14 已完成
- [x] contact + account_contact 表結構穩定（S10 以來）
- [x] 環境就緒

### Session 意圖

- 精神狀態：專注
- 時間預算：3 小時
- 特別注意事項：JSONB 退場需驗證資料一致性，不可遺失現有聯絡人資料

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1**: 作為主管，我希望在 CRM 詳情頁看到客戶的營收指標（總金額、加權金額、案件數）
- [x] **US-2**: 作為開發者，我希望統一從正規化表讀取聯絡人資料，停止 JSONB 雙寫
- [x] **US-3**: 作為開發者，我希望有遷移驗證報告確認 JSONB 資料已完整移至正規化表

### Definition of Done（完成定義）

- [x] DoD-1: `services/sales_plan.py` 新增 `get_summary_by_client()` — 回傳 total_amount / weighted_amount / deal_count
- [x] DoD-2: `pages/crm.py` 客戶詳情頁顯示 3 個營收 metric 卡片
- [x] DoD-3: `services/crm.py` `get_all()` 改從 normalized table JOIN 讀取 DM/Champion 名稱
- [x] DoD-4: `services/crm.py` `create()/update()` 停止寫入 JSONB 欄位（僅寫正規化表）
- [x] DoD-5: `migrate_s15.py` 驗證 JSONB vs 正規化表資料一致性（報告、不 DROP COLUMN）
- [x] DoD-6: `_get_normalized_contacts()` 移除 `information_schema` 檢查（S10 後表已確定存在）

### Context Files（AI 參考檔案）

- `services/crm.py` — 現有雙寫邏輯
- `services/sales_plan.py` — 商機預測 CRUD
- `pages/crm.py` — CRM 頁面
- `database/schema.sql` — contact + account_contact 結構

---

## Stage 2: Vibe Coding

### 實作紀錄

- 修改 `services/sales_plan.py`：新增 get_summary_by_client()，使用 JOIN + SUM + COUNT 聚合
- 修改 `services/crm.py`：
  - get_all() 改用 LEFT JOIN account_contact + contact 取 dm_name 和 champion_names（STRING_AGG）
  - create() / update() 不再寫入 JSONB 欄位（decision_maker, champions），僅寫正規化表
  - _get_normalized_contacts() 移除 information_schema 存在性檢查
  - _sync_contacts_to_normalized() 移除 information_schema 存在性檢查
  - 孤兒清理加入 project_contact 排除條件
- 修改 `pages/crm.py`：
  - 匯入 sales_plan service
  - 詳情頁新增 3 個 st.metric 卡片（商機數/總金額/加權金額）
  - 總覽表改用 dm_name / champion_names（來自 JOIN，不再解析 JSONB）
- 新建 `database/migrate_s15.py`：比對 JSONB 與正規化表的一致性，輸出報告

### TODO / 技術債

- [ ] 未來可考慮 DROP 掉 JSONB 欄位（確認穩定後）

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | get_summary_by_client() 存在 | ✅ | 回傳 deal_count / total_amount / weighted_amount |
| 2 | CRM 詳情頁 metric 卡片 | ✅ | 3 個 st.metric |
| 3 | get_all() 改 JOIN | ✅ | dm_name + champion_names 從正規化表 |
| 4 | 停止 JSONB 寫入 | ✅ | create/update 不再寫 decision_maker/champions JSONB |
| 5 | migrate_s15.py 驗證腳本 | ✅ | 比對報告，不 DROP COLUMN |
| 6 | 移除 information_schema 檢查 | ✅ | 兩處都已移除 |

### 發現的問題

- 無重大問題

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無需修復

### Retro: What went well

- JSONB 退場平滑，不破壞現有功能
- get_all() 的 LEFT JOIN 設計在無聯絡人時仍返回客戶列表（不漏資料）
- 營收 metric 卡片提供即時商業價值可見度

### Retro: What didn't go well

- 初次實作時與 S14/S16 一起完成，跳過了五階段流程

### Retro: Action items for next sprint

- [x] S16 需確認正規化表的完整性（去重前提）
- [x] 健康分數依賴 JSONB 退場後的乾淨資料

### Retro: AI 協作筆記

- 有效的 prompt/context：提供完整的 crm.py service 程式碼，明確標示雙寫區域
- 教訓：移除 information_schema 檢查是正確的（S10 後表一定存在）

### Retro: 時間追蹤

- 預估時間：3 小時
- 實際時間：~1 小時
- 差異原因：變更集中在 crm.py service + pages/crm.py

### Git Commit

- commit hash: `（待 commit）`
- message: `feat(S15): revenue summary + JSONB retirement`
