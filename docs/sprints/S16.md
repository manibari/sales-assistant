# Sprint S16 — 客戶健康分數 + 聯絡人去重

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S15

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S15 — 客戶營收彙總 + JSONB 退場
- 完成狀態: ✅ 已完成（營收 metric 卡片、JSONB 雙寫退場、驗證腳本）

### Sprint 目標宣告

> 為每個客戶建立健康分數（0-100）以量化客戶關係狀態，並為 contact 表加入 UNIQUE 約束防止重複聯絡人。

### 前置條件檢查

- [x] S15 已完成（JSONB 退場，正規化表為唯一資料來源）
- [x] contact + account_contact 表資料已確認一致
- [x] 環境就緒

### Session 意圖

- 精神狀態：專注
- 時間預算：3 小時
- 特別注意事項：去重邏輯需小心處理 FK 指向，避免遺失聯絡人關聯

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1**: 作為主管，我希望每個客戶有健康分數（0-100），以便快速辨識高風險客戶
- [x] **US-2**: 作為開發者，我希望 contact 表有 UNIQUE 約束，防止重複聯絡人
- [x] **US-3**: 作為管理員，我希望有工具偵測並合併現有的重複聯絡人

### Definition of Done（完成定義）

- [x] DoD-1: `constants.py` 新增 `HEALTH_SCORE_WEIGHTS` + `HEALTH_SCORE_THRESHOLDS`
- [x] DoD-2: 新建 `services/client_health.py` — 計算健康分數（活動頻率+最近互動+營收+階段進展）
- [x] DoD-3: `pages/crm.py` 詳情頁顯示健康分數 widget（綠/黃/紅）
- [x] DoD-4: `pages/crm.py` 總覽表加入健康分數欄
- [x] DoD-5: `migrate_s16.py` — 偵測重複聯絡人、合併（更新 account_contact + project_contact FK）、新增 UNIQUE INDEX
- [x] DoD-6: `services/contact.py` `create()` 改用 INSERT ON CONFLICT（upsert）

### Context Files（AI 參考檔案）

- `services/work_log.py` — 活動查詢（含 UNION）
- `services/sales_plan.py` — 營收聚合
- `services/contact.py` — 聯絡人 CRUD
- `pages/crm.py` — CRM 頁面

---

## Stage 2: Vibe Coding

### 實作紀錄

- 修改 `constants.py`：新增 HEALTH_SCORE_WEIGHTS（4 維度共 100 分）和 HEALTH_SCORE_THRESHOLDS（healthy=70, at_risk=40）
- 新建 `services/client_health.py`：
  - compute_health_score()：4 維度評分（activity_recency 30分 / activity_frequency 25分 / deal_value 25分 / deal_progress 20分）
  - compute_all_scores()：批量計算所有客戶分數
  - UNION 查詢整合 project-level + client-level 活動（依賴 S14）
- 修改 `pages/crm.py`：
  - 總覽表新增「健康分數」和「狀態」欄位（良好/注意/警示）
  - 詳情頁新增健康分數 widget（分數+顏色+分項明細）
- 新建 `database/migrate_s16.py`：
  - 偵測 (name, COALESCE(email, '')) 重複群組
  - 合併：保留最小 contact_id，重新指向 account_contact + project_contact FK
  - 建立 UNIQUE INDEX contact_name_email_unique
- 修改 `database/schema.sql`：contact 表後加 UNIQUE INDEX
- 修改 `services/contact.py`：create() 改用 INSERT ON CONFLICT DO UPDATE（upsert）

### TODO / 技術債

- [ ] 健康分數的 deal_value 上限（1M）可依客戶規模調整
- [ ] compute_all_scores() 對大量客戶可能較慢，未來可考慮快取

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|------|-------|------|
| 1 | HEALTH_SCORE_WEIGHTS + THRESHOLDS | ✅ | 4 維度共 100 分 |
| 2 | services/client_health.py | ✅ | compute_health_score() + compute_all_scores() |
| 3 | CRM 詳情頁健康分數 widget | ✅ | 分數 + 顏色（綠/黃/紅）+ 分項 |
| 4 | CRM 總覽表健康分數欄 | ✅ | 健康分數 + 狀態欄位 |
| 5 | migrate_s16.py 去重 + INDEX | ✅ | FK 重新指向 + UNIQUE INDEX |
| 6 | contact.py upsert | ✅ | ON CONFLICT (name, COALESCE(email, '')) |

### 發現的問題

- 無重大問題

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無需修復

### Retro: What went well

- 健康分數的 4 維度設計涵蓋了活動、營收、進展，提供全面的客戶評估
- UNIQUE INDEX 使用 COALESCE(email, '') 正確處理 NULL email 的情境
- 去重邏輯在更新 FK 時加入衝突檢查，避免 PK 違反

### Retro: What didn't go well

- 初次實作時與 S14/S15 一起完成，跳過了五階段流程
- 健康分數的計算為 N+1 查詢模式（每個客戶一次），大量客戶時可能效能不佳

### Retro: Action items for next sprint

- [ ] 考慮將健康分數快取至 CRM 表或 materialized view
- [ ] 匯出與批次操作功能移至未來 Sprint 規劃

### Retro: AI 協作筆記

- 有效的 prompt/context：健康分數公式明確定義（權重 + 閾值），AI 實作精準
- 教訓：去重 migration 需特別注意 FK 衝突處理，不能簡單 UPDATE

### Retro: 時間追蹤

- 預估時間：3 小時
- 實際時間：~1 小時
- 差異原因：健康分數邏輯清晰，去重 SQL 一次到位

### Git Commit

- commit hash: `fc1e31c`
- message: `feat(S16): client health score + contact dedup`
