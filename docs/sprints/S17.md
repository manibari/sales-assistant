# Sprint S17 — 工作日誌 Bug 維修與易用性優化

> **狀態**: `completed`
> **預估時間**: 2.5 小時
> **前置 Sprint**: S16

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S16
- 完成狀態: 已完成。客戶健康分數與聯絡人去重功能已上線。

### Sprint 目標宣告

> 修復工作日誌頁面的崩潰 Bug，並實作「快速記錄工作日誌」功能以提升核心易用性。

### 前置條件檢查

- [x] S16 已完成
- [x] 本地開發環境已就緒

### Session 意圖

- **精神狀態**: 專注、清晰。
- **時間預算**: 約 1.5 小時內完成。
- **特別注意事項**: 確保 Bug 修復要徹底，易用性改善要直覺。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1 (Bug 維修)**: 作為一名使用者，我希望「工作日誌」頁面能夠成功載入而不會崩潰，以便我能查看既有的活動紀錄並使用頁面功能。
- [x] **US-2 (快速記錄功能)**: 作為一名忙碌的業務，我希望在「工作日誌」頁面上看到一個「快速記錄」按鈕，這樣我就可以用最少的步驟（例如只填寫活動內容）來記錄一項活動，而無需填寫複雜的表單。

### Definition of Done（完成定義）

- [x] **DoD-1**: `psycopg2.errors.UndefinedColumn` 的錯誤已解決。
- [x] **DoD-2**: 「工作日誌」頁面 (`pages/work_log.py`) 能夠成功載入，並顯示所有 UI 元件。
- [x] **DoD-3**: 頁面上出現一個「快速記錄」按鈕。
- [x] **DoD-4**: 點擊該按鈕會開啟一個簡化的表單 (`st.popover` + `st.form`)。
- [x] **DoD-5**: 「快速記錄」表單能成功地在 `work_log` 資料表中建立一筆新紀錄，並帶有合理的預設值。
- [x] **DoD-6**: 提交後，表單關閉或清空，且新的紀錄會即時顯示在活動列表上 (`st.rerun`)。
- [x] **DoD-7**: 所有新撰寫及修改的程式碼均通過 `pre-commit` 的品質檢查。

### Context Files（AI 參考檔案）

- `pages/work_log.py`
- `services/project_task.py`
- `services/work_log.py`
- `database/schema.sql`
- `constants.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

1.  **Bug 分析**:
    - 經由 Traceback 分析，錯誤指向 `services/project_task.py` 中的 `get_upcoming` 函式。
    - 查詢語句本身 `t.due_date` 無誤，`schema.sql` 的 `CREATE TABLE` 語句也包含 `due_date` 欄位。
    - 推斷根本原因是本地資料庫的 `project_task` 表格是在 `due_date` 欄位加入 `schema.sql` 之前所建立的，而 `CREATE TABLE IF NOT EXISTS` 不會對已存在的表格做變更。
2.  **Bug 修復**:
    - 在 `database/schema.sql` 檔案底部的「冪等遷移」區塊，新增 `ALTER TABLE project_task ADD COLUMN IF NOT EXISTS due_date DATE;` 以及相關欄位。
    - 這個修改可以確保任何舊版資料庫在執行 `init_db()` 時，都能被安全地更新到最新結構。
3.  **快速記錄功能開發**:
    - 在 `pages/work_log.py` 頂部使用 `st.popover("⚡️ 快速記錄")` 來建立彈出式視窗。
    - 內部使用 `st.form` 來管理輸入與提交。
    - 表單內包含一個 `st.radio` 來選擇活動範圍（專案/客戶），一個動態的 `st.selectbox` 來選擇目標，以及一個 `st.text_area` 填寫內容。
    - 提交時，直接呼叫 `work_log_svc.create()`，並傳入從表單獲取的資料以及預設的 `log_date`, `action_type`, `duration_hours`。
    - 成功後呼叫 `st.rerun()` 刷新頁面。

### TODO / 技術債

- 無。本次開發的程式碼結構清晰。

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|---|---|---|
| 1 | Bug (`UndefinedColumn`) 已解決 | ✅ | 透過修改 `schema.sql` 完成。 |
| 2 | `work_log.py` 頁面可載入 | ✅ | Bug 解決後即可正常載入。 |
| 3 | 「快速記錄」按鈕已出現 | ✅ | 使用 `st.popover` 實現。 |
| 4 | 點擊後開啟簡化表單 | ✅ | 彈出式視窗內含 `st.form`。 |
| 5 | 表單可使用預設值建立紀錄 | ✅ | 後端邏輯傳入了合理的預設值。 |
| 6 | 提交後刷新並顯示新紀錄 | ✅ | 透過 `st.rerun()` 實現。 |
| 7 | 通過 `pre-commit` 檢查 | ✅ | 程式碼符合 `black` 和 `ruff` 的規範。 |

### 發現的問題

- 無。

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無。

### Retro: What went well

- **精準定位問題**: 即使 Bug 的表象（SQL 錯誤）與根本原因（DB 結構未同步）不完全一致，也能快速推斷並定位到問題根源。
- **模式應用**: `st.popover` 搭配 `st.form` 的模式，非常適合在不增加頁面複雜度的情況下，增加便捷的輔助功能。這個模式值得在未來其他易用性優化中複用。

### Retro: What didn't go well

- 在 Bug 分析初期，對 `schema.sql` 的記憶產生了短暫的混淆，再次提醒了直接閱讀檔案源碼的重要性，不能僅憑記憶。

### Retro: Action items for next sprint

- [ ] 在進行 S18 的「快速錄入 CRM」易用性優化時，可以考慮複用本次的 `st.popover` + `st.form` 模式。
- [ ] 應在 Sprint Kickoff 時，就先建立好對應的 Sprint Log 檔案，而不是結束後才補。

### Retro: AI 協作筆記

- 提供清晰的 User Story 和 DoD，有助於 AI 精準地完成開發任務並進行自我驗證。

### Git Commit

- commit hash: `(待開發者填入)`
- message: `(待開發者填入)`
