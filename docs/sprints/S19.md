# Sprint S19 — API 金鑰設定體驗優化與專案自動建立

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S18

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S18
- 完成狀態: 已完成。「AI 智慧記錄」功能第一版已上線，可自動建立客戶 (CRM) 及工作日誌 (Work Log)。

### Sprint 目標宣告

> 優化 API 金鑰的設定引導，提升安全性與使用者體驗；並擴充 AI 智慧記錄功能，使其具備自動建立業務專案 (Project) 的能力。

### 前置條件檢查

- [x] S18 已完成。
- [x] Gemini API 已可正常調用。

### Session 意圖

- **精神狀態**: 擴充現有 AI 邏輯，處理更複雜的資訊解析，並改善使用者體驗。
- **時間預算**: 2.5 小時。
- **特別注意事項**: 確保在不犧牲安全性的前提下提升易用性。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1 (易用性優化)**: 作為使用者，如果我沒有設定 API 金鑰，我希望在「AI 智慧記錄」頁面上看到一個清晰、詳細的指南，一步步告訴我如何建立 `.env` 檔案、應該貼上什麼內容 (`GOOGLE_API_KEY=...`)，以及完成後需要重新啟動應用程式。
- [x] **US-2 (AI 功能擴充)**: 作為使用者，當我在 AI 日誌中提及了商機或專案的關鍵字（例如「簽署POC協議」、「合作案」、「專案」等），我希望系統能自動為我建立一筆新的業務專案 (`project_list`)，並推斷出合理的專案名稱和初始狀態。

### Definition of Done（完成定義）

- [x] **DoD-1**: 當 `.env` 檔案中不存在 `GOOGLE_API_KEY` 時，AI 記錄分頁會顯示一個包含詳細設定教學的 `st.expander` 元件。
- [x] **DoD-2**: `services/intelligent_log.py` 中的 Prompt 已更新，要求 Gemini 模型額外解析出 `project_name` 和 `project_status_code`。
- [x] **DoD-3**: `services/project.py` 中新增了 `find_or_create_project` 輔助函式。
- [x] **DoD-4**: `pages/work_log.py` 中的主流程已更新，在建立完客戶和日誌後，會接著呼叫 `project_svc.find_or_create_project` 來建立新專案。
- [x] **DoD-5**: 整個流程可以端到端運作：輸入一段包含商機的文字，系統會**同時**在 `crm`, `work_log`, 和 `project_list` 中建立對應的資料。
- [x] **DoD-6**: 執行成功後，前端介面會顯示更詳細的成功訊息，告知使用者所有被自動建立的項目。
- [x] **DoD-7**: 所有新程式碼都通過 `pre-commit` 檢查。

### Context Files（AI 參考檔案）

- `pages/work_log.py`
- `services/intelligent_log.py`
- `services/project.py`
- `constants.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

1.  **API 金鑰引導 (US-1)**:
    - 修改 `pages/work_log.py`。
    - 將 `if not os.getenv("GOOGLE_API_KEY")` 區塊內的 `st.error` 替換為一個 `st.expander` 元件。
    - 在 `st.expander` 中，用 Markdown 格式撰寫了詳細的步驟教學，引導使用者建立 `.env` 檔案、貼上金鑰並重啟服務。
2.  **升級 AI Prompt (US-2)**:
    - 修改 `services/intelligent_log.py` 中的 `_SYSTEM_PROMPT`。
    - 在回傳的 JSON Schema 中，新增 `project_name: "string or null"` 和 `project_status_code: "string or null"` 兩個欄位。
    - 更新了 Prompt 的指令說明和範例，指導 LLM 如何根據關鍵字（如 "POC", "客戶開發"）來推斷專案名稱和狀態碼。
3.  **新增 Project 服務 (US-2)**:
    - 修改 `services/project.py`。
    - 新增 `find_or_create_project` 函式。此函式會先依據 `client_id` 和 `project_name` 查詢是否已存在，若否，則呼叫既有的 `create` 函式來建立新專案，最後回傳 `project_id`。
4.  **整合主流程 (US-2)**:
    - 修改 `pages/work_log.py` 中 AI 表單的提交邏輯。
    - 在 `work_log_svc.create` 成功執行後，增加一個判斷式，檢查從 AI 解析回來的資料中是否包含 `project_name`。
    - 如果包含，則呼叫 `project_svc.find_or_create_project`。
    - 將最終的成功訊息 `st.success` 更新，使其能動態地展示所有被自動建立的項目（客戶、日誌、專案）。

### TODO / 技術債

- 無。

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|---|---|---|
| 1 | API 金鑰引導教學 | ✅ | 已用 `st.expander` 實現。 |
| 2 | AI Prompt 已更新 | ✅ | `intelligent_log.py` 已更新。 |
| 3 | Project 服務已擴充 | ✅ | `find_or_create_project` 已新增。 |
| 4 | 主流程已整合 Project 建立 | ✅ | `pages/work_log.py` 已更新。 |
| 5 | 端到端流程可運作 | ✅ | 已完成三種資料表的自動建立。 |
| 6 | 成功訊息已更新 | ✅ | 訊息會動態顯示所有建立的項目。 |
| 7 | 通過 `pre-commit` 檢查 | ✅ | 程式碼符合 `black` 和 `ruff` 規範。 |

### 發現的問題

- 無。

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無。

### Retro: What went well

- **安全與易用性的平衡**: 在不降低安全性的前提下，透過優化 UI 引導，成功解決了使用者設定上的痛點。
- **模式複用**: `find_or_create_*` 的輔助函式模式再次被證明是有效的，它讓服務層的職責更清晰，也讓上層的指揮邏輯更簡潔。

### Retro: What didn't go well

- 在開發過程中，多次遇到 `replace` 工具因 `old_string` 不匹配而失敗的問題。這提醒我，在對同一檔案進行連續修改時，**每次都必須重新 `read_file`**，確保操作的原子性和準確性。

### Retro: Action items for next sprint

- [ ] Sprint 20 的目標將是完成 AI 功能的最後一里路：解析日期與建立 `project_task`。

### Git Commit

- commit hash: `(待開發者填入)`
- message: `(待開發者填入)`
