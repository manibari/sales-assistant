# Sprint S20 — AI 功能穩定性與除錯能力提升

> **狀態**: `completed`
> **預估時間**: 2 小時
> **前置 Sprint**: S19

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S19
- 完成狀態: 已完成。擴充了 AI 功能以建立專案，並優化了 API 金鑰設定引導。
- **Retro 發現**: S19 交付的 AI 功能在處理帶有換行、項目符號的複雜真實文本時，會發生解析失敗，穩定性不足。

### Sprint 目標宣告

> 修復「AI 智慧記錄」功能對複雜文本的解析錯誤，並提升其穩定性與除錯能力。

### 前置條件檢查

- [x] S19 已完成。
- [x] 已準備好用於測試的複雜文本範例。

### Session 意圖

- **精神狀態**: 專注、細緻。專注於提升系統的強健性 (Robustness)。
- **時間預算**: 1.5 小時。
- **特別注意事項**: Prompt Engineering 需要反覆測試，錯誤處理的日誌記錄要清晰。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1 (Bug 維修)**: 作為使用者，當我輸入一段包含換行和項目符號的複雜工作日誌時，我期望系統仍能成功解析，並正確提取出客戶名稱等關鍵資訊。
- [x] **US-2 (開發者體驗優化)**: 作為開發者，當 AI 模型未來再次回傳無效的 JSON 時，我希望系統能將原始的、錯誤的 API 回應文本記錄下來，以便我能快速地診斷問題並優化 Prompt。

### Definition of Done（完成定義）

- [x] **DoD-1**: 您在 Retro 中提供的那段關於「桃園大眾捷運」的複雜文本，現在可以被 AI 功能成功解析。
- [x] **DoD-2**: `services/intelligent_log.py` 中的 `_SYSTEM_PROMPT` 已被優化，能更強健地應對多樣化的輸入格式（例如多重換行、項目符號）。
- [x] **DoD-3**: `services/intelligent_log.py` 中的錯誤處理邏輯已更新，在 JSON 解析失敗時，會將原始的 API 回應印出到後台日誌 (console) 中，方便未來偵錯。

### Context Files（AI 參考檔案）

- `services/intelligent_log.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

1.  **強化 Prompt**:
    - 修改 `services/intelligent_log.py` 中的 `_SYSTEM_PROMPT`。
    - 新增明確指令，要求模型忽略雜訊（如換行、項目符號），並始終回傳單一、有效的 JSON 物件。
    - 新增了一個包含換行與項目符號的複雜範例 (Complex Input)，為模型提供更清晰的指引。
2.  **改善錯誤處理**:
    - 在 `parse_log_entry` 函式的 `try...except` 區塊中，將 `Exception` 的捕捉細分為 `json.JSONDecodeError` 和通用的 `Exception`。
    - 在 `try` 區塊中，先將 API 回傳的原始文本儲存到 `raw_response_text` 變數。
    - 在 `except json.JSONDecodeError` 區塊中，新增了詳細的 `print` 語句，將包含分隔線、錯誤訊息以及最重要的 `raw_response_text` 印出到後台，以達成 US-2 的目標。
3.  **Hotfix #1 (緊急修復)**:
    - 根據使用者回報的後台 console log，發現 API 呼叫因 `404 models/gemini-1.5-flash is not found` 而失敗。
    - 將 `services/intelligent_log.py` 中使用的模型名稱，由 `gemini-1.5-flash` 修正為穩定且廣泛支援的 `gemini-pro`。
4.  **Hotfix #2 & #3 (第二次、第三次緊急修復)**:
    - `gemini-pro` 同樣回報 `404 Not Found` 錯誤。
    - 指導使用者嘗試升級 `google-generativeai` 套件，但發現套件已是最新版，故推翻「版本過舊」的假設。
    - 推斷問題根源極可能在於使用者的 Google Cloud 專案/金鑰環境，與標準模型名稱不相容。
    - 作為當時的最後嘗試，將模型名稱更改為 `gemini-1.0-pro`，以最大化相容性。
5.  **Hotfix #4 (最終修復)**:
    - 在所有嘗試失敗後，建立了一個診斷腳本 `check_models.py`，讓使用者能直接查詢其環境可用的模型列表。
    - 使用者回報，其環境可用的模型名稱為 `gemini-2.5-flash`。
    - 根據此一線索，將模型名稱最終修正為 `gemini-2.5-flash`，徹底解決了 `404` 問題。

### TODO / 技術債

- 無。

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|---|---|---|
| 1 | 複雜文本可解析 | ✅ | 已透過優化 Prompt 和錯誤處理達成。 |
| 2 | Prompt 更強健 | ✅ | 已新增更明確的指令與複雜範例。 |
| 3 | 增強除錯日誌 | ✅ | 解析失敗時會印出原始 AI 回應。 |

### 發現的問題

- 無。

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無。

### Retro: What went well

- **快速反應**: 成功地將前一次 Retro 的回饋轉化為一個專注的、有價值的 Sprint。
- **聚焦根本**: 不僅修復了表面 Bug，還透過增加除錯日誌的方式，提升了該模組未來的可維護性。
- **偵錯手段**: 在多次修復失敗後，果斷採用建立 `check_models.py` 診斷腳本的策略，從根本上解決了資訊不對稱的問題，是本次能成功解決問題的關鍵。

### Retro: What didn't go well

- **錯誤的假設**: 在偵錯初期，連續對模型名稱、套件版本等做出錯誤假設，浪費了數次嘗試。
- **工具限制**: `replace` 工具在處理大塊、可能含有不可見字元的文本時，穩定性不足，未來應更快地切換到 `write_file` 的覆寫策略。

### Retro: Action items for next sprint

- [ ] 現在 AI 功能的穩定性已提升，可以在 Sprint 21 繼續我們原先的計畫：為 AI 功能加入解析**日期**與自動建立**待辦任務 (`project_task`)** 的能力。

### Git Commit

- commit hash: `(待開發者填入)`
- message: `(待開發者填入)`
