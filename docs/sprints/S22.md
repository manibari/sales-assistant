# Sprint S22 — Prompt 管理重構與客戶 ID 生成修正

> **狀態**: `completed`
> **預估時間**: 2.5 小時
> **前置 Sprint**: S21

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S21
- 完成狀態: 已完成。修復了因 `sales_owner` 欄位不存在而導致的資料庫錯誤。AI 功能的核心流程已可穩定運作。
- **Retro 發現**:
    1. AI 的 Prompt 硬編碼在 Python 檔案中，不利於後續維護與擴充。
    2. AI 自動建立客戶時，生成的 `client_id` 格式不標準。

### Sprint 目標宣告

> 將 AI Prompt 從程式碼中分離至獨立的設定檔以利於管理，並修復自動建立客戶時 ID 格式不一致的問題。

### 前置條件檢查

- [x] S21 已完成。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1 (架構重構)**: 作為開發者，我希望在一個獨立的設定檔 (例如 `prompts.yml`) 中管理 AI prompts，以便在不修改 Python 程式碼的情況下，輕鬆地查看、編輯和新增 AI 指令。
- [x] **US-2 (Bug 維修)**: 作為使用者，當系統自動建立一個新客戶時，我期望新的 `client_id` 遵循專案的標準格式 (例如 `CLI-XXX`)，而不是從公司名稱中隨意截取。

### Definition of Done（完成定義）

- [x] **DoD-1**: 專案中存在一個新的 `prompts.yml` 檔案，其中包含「AI 智慧記錄」功能所需的系統提示 (System Prompt)。
- [x] **DoD-2**: `services/intelligent_log.py` 會從 `prompts.yml` 檔案載入其系統提示，而不是將其硬編碼在程式碼中。
- [x] **DoD-3**: `services/crm.py` 中 `find_or_create_client` 函式的 ID 生成邏輯已被修改。
- [x] **DoD-4**: 新的 ID 生成邏輯會查詢資料庫，並產生 `CLI-XXX` 格式的下一個序列號。
- [x] **DoD-5**: 「AI 智慧記錄」功能在應用了上述兩項修改後，依然可以成功、端到端地運作。
- [x] **DoD-6**: `PyYAML` 套件已被加入 `requirements.txt`。

### Context Files（AI 參考檔案）

- `services/intelligent_log.py`
- `services/crm.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

1.  **Prompt 重構 (US-1)**:
    - 將 `PyYAML` 加入 `requirements.txt`。
    - 建立 `prompts.yml` 檔案，並定義一個名為 `ai_smart_log` 的 key，將原有的 System Prompt 完整內容作為其 value。
    - 修改 `services/intelligent_log.py`，移除硬編碼的 `_SYSTEM_PROMPT` 字串。
    - 新增一個 `_load_prompts` 輔助函式，使用 `yaml.safe_load` 從 `prompts.yml` 讀取內容。
    - 在程式啟動時，將 `ai_smart_log` 的內容載入到 `_SYSTEM_PROMPT` 變數中。
2.  **客戶 ID 修正 (US-2)**:
    - 修改 `services/crm.py` 中的 `find_or_create_client` 函式。
    - 移除原本從公司名稱擷取字元來產生 ID 的邏輯。
    - 新增 SQL 查詢 `SELECT client_id FROM crm WHERE client_id LIKE 'CLI-%'`，以獲取所有標準格式的 ID。
    - 在 Python 中遍歷查詢結果，解析出 ID 的數字部分，並找到最大值。
    - 將最大值加一，並使用 f-string `f"CLI-{new_id_num:03d}"` 來格式化為新的、唯一的序列號 ID。
    - 將此新 ID 用於後續的 `create` 函式呼叫。

### TODO / 技術債

- 無。

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|---|---|---|
| 1 | `prompts.yml` 已建立 | ✅ | |
| 2 | Prompt 從檔案載入 | ✅ | |
| 3 | `crm.py` ID 邏輯已修改 | ✅ | |
| 4 | 可產生序列號 ID | ✅ | |
| 5 | 端到端功能正常 | ✅ | |
| 6 | `PyYAML` 已加入 | ✅ | |

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無。

### Retro: What went well

- 本次 Sprint 成功地將一個架構重構任務和一個使用者體驗的 Bug 修復結合在一個週期內完成，顯示了流程的靈活性。
- 新的序列號 ID 生成機制，遠比先前的版本更穩健、更專業。

### Retro: What didn't go well

- 在 S18 初次實現此功能時，為了求快而採用了簡易的 ID 生成邏輯，這筆「技術債」很快就在 S22 就需要償還。這提醒我們在關鍵的 ID 設計上應更深思熟慮。

### Retro: Action items for next sprint

- [ ] AI 功能的架構和核心資料建立部分已趨於穩定。Sprint 23 的目標將是完成此功能的最後一塊拼圖：從文字中解析**日期**與**待辦事項**，並自動在 `project_task` 中建立任務。

### Git Commit

- commit hash: `(待開發者填入)`
- message: `(待開發者填入)`
