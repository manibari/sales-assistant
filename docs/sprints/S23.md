# Sprint S23 — 緊急 Bug 修復與銷售流程優化

> **狀態**: `completed`
> **預估時間**: 2 小時
> **前置 Sprint**: S22

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S22
- 完成狀態: 已完成。重構了 Prompt 管理機制，並修正了客戶 ID 的生成邏輯。
- **Retro 發現**:
    1. (緊急 Bug) `prompts.yml` 檔案存在語法錯誤，導致應用無法啟動。
    2. (優化) AI 建立專案時，`channel` 預設值不理想。
    3. (優化) AI 推斷的專案狀態可能過於超前，缺乏手動校正的機制。
    4. (長程規劃) 需要基於 MEDDIC 的階段關卡機制。

### Sprint 目標宣告

> 修復因 `prompts.yml` 語法錯誤導致的系統崩潰，並實作兩項銷售流程易用性改善：設定預設銷售渠道 (channel)，以及提供手動修改專案狀態的功能。

### 前置條件檢查

- [x] S22 已完成。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1 (緊急維修)**: 作為開發者，我需要修復 `prompts.yml` 的語法錯誤，讓應用程式可以正常啟動。
- [x] **US-2 (體驗優化)**: 當一個專案由 AI 建立時，其 `channel` 欄位應自動預設為 `direct sales`。
- [x] **US-3 (體驗優化)**: 作為使用者，我希望能在案件詳情頁面隨時手動修改一個專案的當前狀態（例如從 L4 退回至 L1）。

### Definition of Done（完成定義）

- [x] **DoD-1**: `prompts.yml` 的 `yaml.scanner.ScannerError` 錯誤已解決，應用可正常啟動。
- [x] **DoD-2**: `services/project.py` 中的 `find_or_create_project` 函式，在建立新專案時，會將 `channel` 預設為 `direct sales`。
- [x] **DoD-3**: 在「案件詳情頁」 (`pages/presale_detail.py`) 上，原先顯示狀態的純文字，已被一個可編輯的狀態下拉選單取代。
- [x] **DoD-4**: 使用者可以透過此下拉選單，成功地變更專案的狀態。

### Context Files（AI 參考檔案）

- `prompts.yml`
- `services/project.py`
- `pages/presale_detail.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

1.  **YAML Bug 修復 (US-1)**:
    - 檢查 `prompts.yml` 檔案，發現錯誤是由於範例 JSON 中的 `log_content` 值包含了一個未正確處理的多行字串，其中的 `to-do:` 讓 YAML 解析器產生混淆。
    - 將該多行字串修改為使用 `\n` 換行符的單行字串，使其符合 YAML 語法規範，解決了解析錯誤。
2.  **Channel 預設值修正 (US-2)**:
    - 修改 `services/project.py` 中的 `find_or_create_project` 函式。
    - 在呼叫 `create` 函式建立新專案時，將 `channel` 參數的值由 `"ai_log"` 硬編碼改為 `"direct sales"`。
3.  **狀態修改功能 (US-3)**:
    - **後端修改**: 為了允許使用者自由「退回」狀態，首先修改 `services/project.py` 中的 `transition_status` 函式，為其增加一個 `force=False` 的布林參數。將原有的轉換規則驗證邏輯，包在 `if not force:` 區塊中。
    - **前端修改**: 接著修改 `pages/presale_detail.py`。
        - 移除了原有的「狀態流轉」分頁。
        - 在頁面頂部，將顯示狀態的 `st.metric` 元件，替換為一個 `st.selectbox` 下拉選單。
        - 該選單提供了所有售前階段的選項，並使用 `on_change` 回呼函式。
        - 當使用者選擇新狀態時，回呼函式會呼叫 `project_svc.transition_status(..., force=True)`，強制更新狀態並彈出成功提示。

### TODO / 技術債

- 無。

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|---|---|---|
| 1 | YAML Bug 已修復 | ✅ | |
| 2 | Channel 預設值已修正 | ✅ | |
| 3 | 狀態下拉選單已實作 | ✅ | |
| 4 | 狀態可成功變更 | ✅ | |

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無。

### Retro: What went well

- 本次 Sprint 反應迅速，在一個週期內同時解決了系統的阻斷性 Bug 和使用者體驗流程的優化點。
- 為 `transition_status` 函式增加 `force` 參數是一個很好的設計模式，在不破壞既有業務規則的前提下，給予了使用者手動覆寫的權力。

### Retro: What didn't go well

- 在 Retro 中提出的「MEDDIC 關卡」是一個史詩級 (Epic) 的大型功能，需要更長的規劃週期。將其與 Bug 修復放在同一個 Sprint 討論，容易導致範疇失焦。

### Retro: Action items for next sprint

- [ ] **Sprint 24 規劃**: 現在 Bug 和核心易用性問題已處理完畢，下一個 Sprint 的目標應該是為「MEDDIC 關卡機制」這個史詩級功能，進行一次完整的**需求分析與技術設計**，產出必要的資料庫 Schema 變更、UI Mockup 和開發計畫，但不立即進行實作。

### Git Commit

- commit hash: `(待開發者填入)`
- message: `(待開發者填入)`
