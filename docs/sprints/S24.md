# Sprint S24 — MEDDIC 關卡機制：設計與規劃

> **狀態**: `pending`
> **預估時間**: 2 小時
> **前置 Sprint**: S23

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S23
- 完成狀態: 已完成。修復了 `prompts.yml` 的 Bug，並交付了 Channel 預設值和手動修改狀態的易用性優化。
- **Action Item**: S24 的目標是為「MEDDIC 關卡機制」這個史詩級功能進行完整的需求分析與技術設計。

### Sprint 目標宣告

> 完成 MEDDIC 銷售流程關卡功能的完整設計，包含資料庫 Schema 設計、前端介面規劃、以及後端邏輯流程，為後續的開發 Sprint 奠定基礎。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1 (設計)**: 作為產品規劃者，我需要定義儲存 MEDDIC 各項指標所需的新資料表 Schema。
- [x] **US-2 (設計)**: 作為產品規劃者，我需要定義在專案的哪個階段推進到下一個階段時，必須完成哪些 MEDDIC 項目（即「關卡規則」）。
- [x] **US-3 (設計)**: 作為產品規劃者，我需要規劃出讓使用者可以方便地填寫和檢視 MEDDIC 分析內容的前端介面。
- [x] **US-4 (設計)**: 作為產品規劃者，我需要規劃出後端服務如何根據「關卡規則」來驗證並執行狀態轉換的邏輯。

### Definition of Done（本 Sprint 的交付產出）

*   [ ] **DoD-1**: 新的 `project_meddic` 資料表的 `CREATE TABLE` 語句已完成，並被新增至 `database/schema.sql` 中（可先註解掉，待開發時啟用）。
*   [ ] **DoD-2**: MEDDIC 各階段的「關卡規則」已被明確定義在此 `S24.md` 文件的「設計規劃」章節中。
*   [ ] **DoD-3**: UI/UX 設計：前端「MEDDIC」分頁的介面佈局與互動流程已被詳細描述。
*   [ ] **DoD-4**: 後端架構：需要新增或修改的服務 (`meddic.py`, `project.py`) 及其函式職責已被詳細描述。
*   [ ] **DoD-5**: 所有設計決策均完整記錄於此 `S24.md` 文件中。

### Context Files（AI 參考檔案）

- `database/schema.sql`
- `services/project.py`
- `pages/presale_detail.py`

---

## Stage 2: Design & Planning (取代 Vibe Coding)

### 1. 資料庫設計 (Database Schema)

- 新增一個 `project_meddic` 資料表。
- 此表格與 `project_list` 為一對一關係。

```sql
-- To be added to schema.sql
CREATE TABLE IF NOT EXISTS project_meddic (
    project_id               INTEGER PRIMARY KEY REFERENCES project_list(project_id) ON DELETE CASCADE,
    metrics                  TEXT, -- 指標: 客戶希望達成的量化效益
    economic_buyer           TEXT, -- 經濟決策者: 最終拍板的人是誰
    decision_criteria        TEXT, -- 決策標準: 客戶用什麼標準來評估廠商
    decision_process         TEXT, -- 決策流程: 客戶內部的採購流程、時程
    identify_pain            TEXT, -- 痛點: 他們現在具體遇到了什麼困難
    champion                 TEXT, -- 擁護者: 我們在客戶內部的「自己人」是誰
    updated_at               TIMESTAMPTZ DEFAULT NOW()
);
```

### 2. UI/UX 設計

- 在 `pages/presale_detail.py` 中，新增一個名為 **"MEDDIC"** 的分頁 (Tab)。
- 此分頁內包含一個表單 (`st.form`)。
- 表單中包含 6 個 `st.text_area`，分別對應 `project_meddic` 表中的 `metrics`, `economic_buyer`, `decision_criteria`, `decision_process`, `identify_pain`, `champion`。
- 表單有一個「儲存」按鈕，點擊後會呼叫新的 `meddic_svc.save_or_update` 函式。

### 3. 後端架構設計

- **新增 `services/meddic.py`**:
    - `get_by_project(project_id)`: 獲取指定專案的 MEDDIC 資料。
    - `save_or_update(...)`: 儲存或更新指定專案的 MEDDIC 資料 (使用 `INSERT ... ON CONFLICT ... DO UPDATE` 語法)。
- **修改 `services/project.py`**:
    - 修改 `transition_status(project_id, new_status, force=False)` 函式。
    - 在 `if not force:` 區塊內，增加呼叫「關卡規則檢查」的邏輯。
    - 新增內部函式 `_check_meddic_gate(project_id, new_status)`:
        - 此函式會從 `meddic_svc` 獲取資料。
        - 根據下方定義的「關卡規則」，檢查 `new_status` 所需的欄位是否都已填寫。
        - 若有未填寫的欄位，則 `raise ValueError("請先完成 MEDDIC 的以下項目：[未填寫的項目]")`。

### 4. 關卡規則定義 (Gating Rules)

這是我們需要一起討論和確認的核心業務邏輯。以下是一個初步的建議：

| 目標狀態 | 必要完成的 MEDDIC 項目 |
|---|---|
| **L2 (提案)** | `Identify Pain` (必須知道客戶痛點才能提案) |
| **L3 (確認意願)** | `Champion` (必須找到內部擁護者，才能確認真實意願) |
| **L4 (執行 POC)** | `Decision Criteria` (必須了解決策標準，POC 才會有方向) |
| **L5 (完成 POC)** | `Metrics` (必須定義好量化指標，才能衡量 POC 是否成功) |
| **L6 (議價)** | `Economic Buyer` (必須接觸到經濟決策者，才能進入議價) |
| **L7 (簽約)** | `Decision Process` (必須了解完整的決策流程，才能完成簽約) |

---

## Stage 3: Sprint Review

### DoD 驗證結果

> (Sprint 完成後填寫)

---

## Stage 4: Retrospective & Refactor

> (Sprint 完成後填寫)
