# Sprint S25 — MEDDIC 關卡機制：實作開發

> **狀態**: `completed`
> **預估時間**: 3 小時
> **前置 Sprint**: S24

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S24
- 完成狀態: 已完成。產出了 MEDDIC 關卡機制的完整設計藍圖，包括 DB Schema、UI/UX 規劃、後端架構和業務規則。

### Sprint 目標宣告

> 根據 S24 的設計藍圖，完成 MEDDIC 關卡功能的完整開發，包括建立新的資料表、實作後端服務與驗證邏輯，以及建構前端的填寫介面。

### 前置條件檢查

- [x] S24 設計 Sprint 已完成並達成共識。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1 (DB & Service)**: 系統中需包含 `project_meddic` 資料表，並有對應的後端服務 (`meddic.py`) 來進行讀取和儲存。
- [x] **US-2 (UI)**: 在案件詳情頁，我希望能看到一個新的「MEDDIC」分頁，並在其中填寫、儲存和查看該專案的 MEDDIC 分析內容。
- [x] **US-3 (Gating Logic)**: 當我嘗試推進專案狀態時（非強制模式），系統應根據 S24 定義的「關卡規則」進行驗證，如果必要的 MEDDIC 項目未填寫，應提示我並阻止狀態變更。

### Definition of Done（本 Sprint 的交付產出）

*   [x] **DoD-1**: `database/schema.sql` 檔案中已包含 `project_meddic` 的 `CREATE TABLE` 語句。
*   [x] **DoD-2**: 新的 `services/meddic.py` 檔案已建立，並包含 `get_by_project` 和 `save_or_update` 函式。
*   [x] **DoD-3**: `pages/presale_detail.py` 頁面已新增「MEDDIC」分頁，其中包含可提交的表單。
*   [x] **DoD-4**: `services/project.py` 中的 `transition_status` 函式已整合了關卡驗證邏輯。
*   [x] **DoD-5**: 端到端測試：一個未填寫 `Identify Pain` 的 L1 專案，在嘗試（非強制）更新到 L2 時會被系統阻擋並提示。
*   [x] **DoD-6**: 端到端測試：在 MEDDIC 頁面填寫完所有資料後，專案可以順利地從 L1 一路推進到 L7。

### Context Files（AI 參考檔案）

- `docs/sprints/S24.md` (本次開發的設計藍圖)
- `database/schema.sql`
- `services/project.py`
- `pages/presale_detail.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

1.  **資料庫層 (DB)**:
    - 根據 S24 設計，將 `CREATE TABLE IF NOT EXISTS project_meddic (...)` 的 SQL 語句新增至 `database/schema.sql` 中。
2.  **服務層 (Service)**:
    - 建立新檔案 `services/meddic.py`。
    - 在其中實作 `get_by_project(project_id)` 函式，用於查詢指定專案的 MEDDIC 資料。
    - 實作 `save_or_update(...)` 函式，使用 `INSERT ... ON CONFLICT DO UPDATE` 語法來寫入或更新 MEDDIC 資料。
3.  **介面層 (UI)**:
    - 修改 `pages/presale_detail.py`。
    - 匯入新建的 `meddic_svc`。
    - 在 `st.tabs` 中新增一個「MEDDIC」分頁。
    - 在該分頁內，建立一個 `st.form`，其中包含 6 個對應 MEDDIC 欄位的 `st.text_area`，並從 `meddic_svc.get_by_project` 載入預設值。
    - 實作表單提交邏輯，呼叫 `meddic_svc.save_or_update` 來儲存資料。
4.  **核心邏輯 (Gating)**:
    - 修改 `services/project.py`。
    - 匯入 `meddic_svc`。
    - 建立一個內部輔助函式 `_check_meddic_gate(project_id, new_status)`，此函式包含一個定義了各階段所需欄位的字典 `_MEDDIC_GATE_RULES`。
    - `_check_meddic_gate` 會根據目標狀態 `new_status`，檢查對應的 MEDDIC 欄位是否都已填寫，否則 `raise ValueError` 並附上清晰的錯誤訊息。
    - 在 `transition_status` 函式中，於 `if not force:` 區塊內，優先呼叫 `_check_meddic_gate` 進行驗證。
5.  **最終重構 (Refactor)**:
    - 在完成上述功能後，重構了 `presale_detail.py` 的狀態變更 UI。
    - 移除了 `st.selectbox` 的 `on_change` 回呼，改為使用一個明確的「更新狀態」按鈕。
    - 新增一個「強制轉換」的 `st.checkbox`，讓使用者可以選擇是否要繞過 MEDDIC 和標準流程的規則。
    - 將兩種模式（一般推進與強制轉換）整合到同一個按鈕邏輯中，使介面更清晰、行為更可預測。

### TODO / 技術債

- 無。

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|---|---|---|
| 1 | DB Schema 已新增 | ✅ | |
| 2 | MEDDIC 服務已建立 | ✅ | |
| 3 | MEDDIC UI 已完成 | ✅ | |
| 4 | Gating 邏輯已整合 | ✅ | |
| 5 | Gating 阻擋測試 | ✅ | |
| 6 | Gating 通過測試 | ✅ | |

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 重新設計了 `presale_detail.py` 的狀態轉換 UI，使其能同時支援有關卡的正常推進和可繞過規則的強制修改。

### Retro: What went well

- **設計驅動開發**: 歸功於 S24 的充分設計，本次 Sprint 的開發過程非常流暢，目標明確，沒有出現重大的方向性問題。
- **快速重構**: 在開發尾聲，能快速識別並重構一個不夠完善的 UI 互動，確保了最終交付的品質。

### Retro: What didn't go well

- 無，本次 Sprint 堪稱典範。

### Retro: Action items for next sprint

- [ ] 完成了 MEDDIC 這個史詩級功能後，我們可以回到 AI 功能的最後一塊拼圖：從文字中解析**日期**與**待辦事項**，並自動在 `project_task` 中建立任務。這將是 Sprint 26 的目標。

### Git Commit

- commit hash: `(待開發者填入)`
- message: `(待開發者填入)`
