# Sprint S27 — 外部化業務規則，提升系統彈性

> **狀態**: `completed`
> **預估時間**: 2 小時
> **前置 Sprint**: S26

---

## Stage 0: Sprint Kickoff

### Sprint 目標宣告

> 將硬編碼在 `services/project.py` 中的 MEDDIC「關卡規則」重構並抽離至一個獨立的 `rules.yml` 設定檔中，實現業務規則與程式碼的解耦，讓銷售流程的調整更具彈性。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1**: 作為銷售主管/管理者，我希望能夠透過修改一個簡單的設定檔（而不是 Python 程式碼）來調整 MEDDIC 的關卡條件（例如，將 L2 升 L3 的必要條件從「擁護者」改為「痛點」）。

### Definition of Done（完成定義）

- [x] **DoD-1**: 專案根目錄下已建立 `rules.yml` 檔案。
- [x] **DoD-2**: 原本在 `services/project.py` 中的 `_MEDDIC_GATE_RULES` 字典內容，已被完整遷移至 `rules.yml`。
- [x] **DoD-3**: `services/project.py` 現在會讀取 `rules.yml` 的內容來執行關卡驗證。
- [x] **DoD-4**: MEDDIC 關卡驗證功能在重構後，行為與之前完全一致，可以正常阻擋或放行狀態轉換。

### Context Files（AI 參考檔案）

- `services/project.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

1.  **建立設定檔**:
    - 在專案根目錄下建立一個新檔案 `rules.yml`。
    - 將 `services/project.py` 中 `_MEDDIC_GATE_RULES` 字典的內容，以 YAML 的格式，完整地複製到 `rules.yml` 中。
2.  **重構服務層**:
    - 修改 `services/project.py`。
    - 在檔案頂部 `import yaml`。
    - 移除硬編碼的 `_MEDDIC_GATE_RULES` 字典。
    - 新增一個內部輔助函式 `_load_rules()`，該函式負責開啟 `rules.yml`，使用 `yaml.safe_load()` 解析內容，並從中提取出 `meddic_gate_rules` 的部分。同時也加入了檔案不存在的例外處理。
    - 讓 `_MEDDIC_GATE_RULES` 這個全域變數，改為接收 `_load_rules()` 函式的回傳值。
    - `_check_meddic_gate` 函式無需任何修改，因為它讀取的是 `_MEDDIC_GATE_RULES` 變數，現在這個變數的資料來源已經被無縫地替換掉了。

### TODO / 技術債

- 無。

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|---|---|---|
| 1 | `rules.yml` 已建立 | ✅ | |
| 2 | 規則已遷移 | ✅ | |
| 3 | `project.py` 已重構 | ✅ | |
| 4 | 功能驗證一致 | ✅ | |

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無。

### Retro: What went well

- 這是一次非常乾淨俐落的重構 Sprint。我們成功地將易變的「業務規則」與相對穩定的「程式邏輯」進行了解耦，這對於系統的長期維護非常有益。

### Retro: What didn't go well

- 無，本次 Sprint 非常順利。

### Retro: Action items for next sprint

- [ ] 按照我們的路線圖，下一個 Sprint (S28) 將是「外部化 SQL 查詢」，這會是另一次重要的可維護性提升。

### Git Commit

- commit hash: `(待開發者填入)`
- message: `(待開發者填入)`
