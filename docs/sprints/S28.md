# Sprint S28 — 外部化 SQL 查詢，提升程式碼可維護性

> **狀態**: `completed`
> **預估時間**: 2.5 小時
> **前置 Sprint**: S27

---

## Stage 0: Sprint Kickoff

### Sprint 目標宣告

> 建立 `database/queries/` 目錄，並選定一至兩個核心服務作為示範，將其內部複雜的 SQL 查詢語句重構至獨立的 `.sql` 檔案中，以提升程式碼的可讀性與長期可維護性。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1**: 作為開發者，我希望將複雜的 SQL 查詢語句與 Python 業務邏輯分離，當我需要優化查詢時，可以直接在 `.sql` 檔案中進行，而不需要在 Python 函式中大海撈針。

### Definition of Done（完成定義）

- [x] **DoD-1**: `database/queries/` 目錄已成功建立。
- [x] **DoD-2**: 至少一個服務檔案（例如 `services/project.py`）中的一個複雜查詢，已被遷移到 `.sql` 檔案中。
- [x] **DoD-3**: 對應的 Python 服務函式已被重構，其邏輯變為讀取 `.sql` 檔案並執行。
- [x] **DoD-4**: 功能在重構前後保持一致，沒有產生新的 Bug。

### Context Files（AI 參考檔案）

- `services/project.py`
- `services/crm.py`
- `database/connection.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

1.  **建立目錄**:
    - 執行 `mkdir -p database/queries` 建立新目錄。
2.  **建立輔助函式**:
    - 為了讓讀取 `.sql` 檔案的邏輯可以被複用，首先修改了 `database/connection.py`。
    - 在其中新增了一個 `read_sql_file(file_name: str)` 輔助函式，它會自動組合正確的檔案路徑、讀取檔案內容並回傳字串。
3.  **重構 `services/crm.py`**:
    - 將 `get_all()` 函式中的 `SELECT ...` 查詢語句，完整地剪下並貼到新檔案 `database/queries/crm_get_all.sql` 中。
    - 修改 `get_all()` 函式，將原本的多行 SQL 字串，替換為一行 `sql = read_sql_file("crm_get_all.sql")`。
4.  **重構 `services/project.py`**:
    - 將 `get_closed()` 函式中的 `SELECT ...` 查詢語句，遷移至新檔案 `database/queries/project_get_closed.sql` 中。
    - 修改 `get_closed()` 函式，同樣使用 `read_sql_file("project_get_closed.sql")` 來載入查詢。

### TODO / 技術債

- 無。

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|---|---|---|
| 1 | 目錄已建立 | ✅ | |
| 2 | 服務已重構 | ✅ | `crm.py` 和 `project.py` 都已重構。 |
| 3 | SQL 已遷移 | ✅ | `crm_get_all.sql` 和 `project_get_closed.sql` 已建立。 |
| 4 | 功能驗證一致 | ✅ | |

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無。

### Retro: What went well

- 本次 Sprint 成功建立了一個清晰、可複用的新模式，用於管理 SQL 查詢。
- 「先建立共用輔助函式」的策略是正確的，它讓後續對多個服務的重構變得非常簡單。

### Retro: What didn't go well

- 無，本次 Sprint 非常順利。

### Retro: Action items for next sprint

- [ ] 按照我們的路線圖，下一個 Sprint (S29) 將是「AI 任務非同步處理」，這將是一次更複雜、也更有價值的架構升級。

### Git Commit

- commit hash: `(待開發者填入)`
- message: `(待開發者填入)`
