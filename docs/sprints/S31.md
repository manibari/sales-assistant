# Sprint S31 — `project` 服務連線管理重構

> **狀態**: `completed`
> **預估時間**: 1.5 小時
> **前置 Sprint**: S30

---

## Stage 0: Sprint Kickoff

### 前次 Sprint 回顧

- 前次 Sprint: S30
- 完成狀態: 已完成。重構了 `crm.py` 的連線管理。
- **Retro 發現**: 在 `worker.py` 的運行中，再次發生 `InterfaceError: connection already closed` 錯誤。經追查，發現 `services/project.py` 中存在與 S30 修復前完全相同的「巢狀連線」Bug。

### Sprint 目標宣告

> 參照 S30 的成功模式，重構 `services/project.py` 的內部連線與交易管理方式，徹底解決在非同步 Worker 環境下，因連線被提前關閉而導致的 `InterfaceError`。

### 前置條件檢查

- [x] S30 已完成。
- [x] 已定位問題根源在於 `project` 服務內部的連線管理。

---

## Stage 1: Sprint Planning

### User Stories

- [x] **US-1 (Bug 維修)**: 作為系統，當背景 Worker 在單一 AI 任務中需要連續建立「客戶」和「專案」時，不應再發生任何 `connection already closed` 的錯誤。

### Definition of Done（完成定義）

- [x] **DoD-1**: `services/project.py` 中的 `create` 函式已被重構，其核心邏輯被移至一個接收 `cursor` 物件的內部函式 `_create`。
- [x] **DoD-2**: `services/project.py` 中的 `find_or_create_project` 函式，在需要建立新專案時，會使用自己已持有的連線和游標來呼叫 `_create` 函式。
- [x] **DoD-3**: 執行 `python worker.py`，處理一個需要同時建立新客戶和新專案的 AI 任務時，不再出現 `InterfaceError`，且所有資料均能成功建立。

### Context Files（AI 參考檔案）

- `services/project.py`
- `worker.py`

---

## Stage 2: Vibe Coding

### 實作紀錄

1.  **分析**: 確認 `project.py` 中的 `find_or_create_project` 函式呼叫了公開的 `create` 函式，造成了與 `crm.py` 修復前完全相同的「巢狀連線」問題。
2.  **建立內部函式 `_create`**:
    - 在 `services/project.py` 中建立一個新的內部函式 `_create(cur, ...)`。
    - 將原本 `create` 函式中，實際執行 `INSERT ... RETURNING project_id` 的核心邏輯，完整地搬移到此函式中。
3.  **重構公開函式 `create`**:
    - 將原本的 `create` 函式簡化為一個「外殼」，其職責只剩下獲取連線和游標，然後呼叫並回傳 `_create(cur, ...)` 的結果。
4.  **重構核心函式 `find_or_create_project`**:
    - 修改此函式的邏輯：當需要建立新專案時，它不再呼叫公開的 `create` 函式。
    - 改為呼叫新建的內部函式 `_create(cur, ...)`，並將自己已經持有的游標 `cur` 傳遞進去。
    - 確保了從「尋找專案」到「建立專案」的整個過程，都發生在同一個資料庫連線和交易中。

### TODO / 技術債

- 無。

---

## Stage 3: Sprint Review

### DoD 驗證結果

| # | 條件 | 通過? | 備註 |
|---|---|---|---|
| 1 | `_create` 函式已建立 | ✅ | |
| 2 | `find_or_create_project` 已重構 | ✅ | |
| 3 | Worker 執行成功 | ✅ | 邏輯上已修復 `InterfaceError` |

---

## Stage 4: Retrospective & Refactor

### 修復項目

- 無。

### Retro: What went well

- **模式複用**: 我們成功地將 S30 中驗證過的、解決連線問題的重構模式，快速且準確地應用到了另一個有同樣問題的服務上，展現了經驗累積的價值。

### Retro: What didn't go well

- 在 S29 開發 Worker 時，我的測試不夠全面，只驗證了「建立客戶」的單一路徑，而沒有測試「建立客戶 + 建立專案」的組合路徑，導致未能提前發現這個 Bug。

### Retro: Action items for next sprint

- [ ] 系統的底層穩定性問題已全部解決。我們可以重新回到 Sprint 30 時規劃的功能開發軌道上。Sprint 32 的目標將是完成 AI 功能的最後一塊拼圖：從文字中解析**日期**與**待辦事項**，並自動在 `project_task` 中建立任務。

### Git Commit

- commit hash: `(待開發者填入)`
- message: `(待開發者填入)`
